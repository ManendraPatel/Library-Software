<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>Library Management-A MS Technology</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1RN9WAiLZ4MsZLzx9fKXgOCeaGWZvvjyj">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
	
	/* Header ke niche wale 3 Buttons/Cards ke liye */
.stats-bar .stat-item, .nav-cards .card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Smooth Spring Animation */
    cursor: pointer;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(241, 196, 15, 0.2);
}

#studentListContainer {
    flex-grow: 1;
    height: 400px; /* Isse fix height milegi */
    max-height: 60vh; /* Screen ke hisab se scroll bar lane ke liye */
    overflow-y: auto !important; /* Scrollbar wapas lane ke liye */
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    margin-bottom: 80px; /* Footer se dur rakhne ke liye */
}

/* Jab table empty ho (baaki pages par), toh container space na le */
#studentListContainer:empty {
    display: none;
}

.myTable thead th {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #34495e !important;
    color: white;
}
/* Header ko scroll karte waqt upar chipkane ke liye */
.myTable th {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #34495e;
}



/* Hover Effect: Jab cursor button par jaye */
.stats-bar .stat-item:hover, .nav-cards .card:hover {
    transform: translateY(-8px) scale(1.02); /* Thoda upar uthega aur bada hoga */
    border-color: #f1c40f; /* Border Gold ho jayegi */
    box-shadow: 0 10px 25px rgba(241, 196, 15, 0.3); /* Gold Glow effect */
    background: linear-gradient(145deg, #1a1a1a, #000000); /* Darker gradient on hover */
}

/* Shine Effect Animation (Optional but very Premium) */
.stats-bar .stat-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        120deg,
        transparent,
        rgba(241, 196, 15, 0.1),
        transparent
    );
    transition: 0.5s;
}

.stats-bar .stat-item:hover::before {
    left: 100%; /* Cursor le jane par ek chamak (shine) cross karegi */
}

/* Active State: Jab button click karein */
.stats-bar .stat-item:active {
    transform: translateY(-2px) scale(0.98); /* Click karne par dabne wala effect */
}
	.stats-bar { 
    display: flex; 
    gap: 30px; /* Buttons ke beech gap badhane ke liye */
    margin-bottom: 20px; 
	margin-top: 8px;
    padding: 0 5px;
}

.stat-item { 
    flex: 1; 
    padding: 3px; /* Size bada karne ke liye */
    border-radius: 12px; 
    /* Baki purana style rehne dein */
}
	
	/* Logo Holder Styling */
.logo-holder { 
    width: 100px; /* Professional Standard Size */
    height: 100px; 
    border-radius: 50%; /* Perfect Round Shape */
    background: #fff; 
    border: 2px solid var(--gold); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    overflow: hidden; /* Bahar nikalne wali image ko kaat dega */
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    flex-shrink: 0; /* Header mein dabaav se bachaane ke liye */
}

/* Logo Image Styling */
.logo-holder img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; /* Image ko bina stretch kiye fit karega */
}
	
	.report-stat-card {
    background: white;
    padding: 3px 5px; /* Padding thoda kam kiya */
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    text-align: right;
    min-width: 160px;
    margin: 0; /* Extra white space hatane ke liye */
}
.report-stat-card div { font-size: 20px; font-weight: 600; }

.filter-bar-premium {
    background: #f8f9fa;
    padding: 8px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    border: 1px solid #dee2e6;
	border-collapse: collapse;
}

/* Seat Number ka Badge */
.badge-seat {
    background: #f1c40f;
    color: #000;
    padding: 2px 8px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 12px;
}

/* Button Group Container */
.action-btn-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* Premium Button Base Style */
.premium-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    color: white !important;
}

.premium-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Colors */
.btn-call { background: linear-gradient(135deg, #3498db, #2980b9); }
.btn-pay { background: linear-gradient(135deg, #f39c12, #e67e22); }
.btn-wa { background: linear-gradient(135deg, #2ecc71, #27ae60); }

/* Icons size fix */
.premium-btn i { font-size: 14px; }


.table-wrapper-report table { width: 100%; border-collapse: collapse; background: white; }
.table-wrapper-report th { background: #455a64; color: white; padding: 8px; text-align: left; font-size: 12px; }
.table-wrapper-report td { padding: 12px; border-bottom: 1px solid #eee; font-size: 12px; }

.btn-premium-red { background: #d32f2f; color: white; border: none; padding: 5px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.btn-premium-blue { background: #1e3c72; color: white; border: none; padding: 5px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }
.premium-input-search { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 250px; }
	
	
	
	/* --- Settings Section Organization Fix --- */
.settings-premium-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 20px;
    max-height: calc(100vh - 250px); /* Screen height ke hisab se adjust */
    overflow-y: auto; /* Agar screen choti ho toh scroll dikhe */
    padding-bottom: 10px;
}

.settings-card {
    background: white;
    padding: 10px; /* Padding kam ki taaki buttons upar aayein */
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    border: 1px solid #f0f0f0;
    display: flex;
    flex-direction: column;
}

/* Settings ke inputs ko thoda compact kiya */
.premium-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 5px;
}

.input-group {
    margin-bottom: 3px;
}

.premium-btn-save {
    width: 100%;
    padding: 10px; /* Padding choti ki taaki height kam ho */
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    margin-top: 10px;
}
/* Logo Upload Style */
.logo-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.logo-preview-wrapper {
    width: 100px;
    height: 100px;
    border-radius: 15px;
    border: 2px dashed #ddd;
    position: relative;
    cursor: pointer;
    overflow: hidden;
    background: #fdfdfd;
}

.logo-preview-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.logo-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
}

.logo-preview-wrapper:hover .logo-overlay { display: flex; }

.forgot-pin-box {
    margin-top: 20px;
    background: #fff9db;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    color: #856404;
    border: 1px solid #ffeeba;
    text-align: center;
}
	
	
/* Premium Landscape ID Card - FIXED DESIGN */
.id-card-premium-landscape {
    width: 550px;
    height: 320px;
    background: #fff;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    font-family: 'Poppins', sans-serif;
    display: flex;
    border: 1px solid #ddd;
    margin: 20px auto;
}

/* Left Sidebar (Dark Section) */
.id-left-panel {
    width: 40%;
    background: #1a1a1a;
    color: white;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%);
    z-index: 2;
}

.id-left-panel .logo-circle {
    width: 90px;
    height: 90px;
    background: white;
    border-radius: 50%;
    padding: 5px;
    margin-bottom: 10px;
}

.id-left-panel .lib-info {
    text-align: center;
    font-size: 10px;
    line-height: 1.4;
}

/* Data Labels on Dark Section */
.id-details-left {
    margin-top: 10px;
    width: 100%;
}

.label-box {
    background: #ff0000;
    font-size: 11px;
    padding: 2px 6px;
    font-weight: 600;
    display: inline-block;
    margin-top: 10px;
}

.value-text {
    font-size: 11px;
    border-bottom: 1px solid #444;
    display: block;
    padding: 2px 0 5px 0;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.id-right-panel {
    width: 60%;
    background: white;
    padding: 25px 20px 20px 35px;
    position: relative;
    display: flex;
    flex-direction: column;
}
.id-info-block b {
    font-size: 10px;
    color: #ff0000; /* Header color match */
    letter-spacing: 0.5px;
    display: block;
    margin-bottom: 2px;
}

.student-name-big {
    font-size: 36px;
    font-weight: 800;
    color: #ff0000;
    text-transform: uppercase;
    margin: 0;
    line-height: 1;
}

.id-row {
    display: flex;
    gap: 30px;
    margin-top: 20px;
}

.info-item b {
    display: block;
    font-size: 12px;
    color: #666666;
}

.info-item span {
    font-size: 12px;
    font-weight: 700;
    color: #1a1a1a;
}

/* Photo Section */
.photo-holder {
    position: absolute;
    right: 15px;
    bottom: 25px;
    width: 100px;
    height: 120px;
    border: 1px solid #00a8ff;
    border-radius: 8px;
    background: #f8f8f8;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.photo-holder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Red Bottom Strip */
.id-footer-strip {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 12px;
    background: #ff0000;
}

.id-address-block {
    margin-top: 15px;
	font-size: 12px;
    width: 190px; /* Isse address photo box ke pehle hi ruk jayega */
    text-align: left;
    word-wrap: break-word; /* Lambe words ko todne ke liye */
}

#idFinalAddress {
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Maximum 2 line dikhayega */
    -webkit-box-orient: vertical;
}

.id-address-block p {
    font-size: 12px;
    color: #666;
    font-weight: 600;
    margin: 0;
    line-height: 1.3;
    /* Multiline handle karne ke liye */
    display: -webkit-box;
    -webkit-line-clamp: 3; 
    -webkit-box-orient: vertical;
    overflow: hidden;
}
#idAddressNew {
    margin: 0;
    line-height: 1.2;
    max-height: 45px; /* Taaki red strip se na takraye */
    overflow: hidden;
    text-transform: capitalize;
}

/* Right Panel adjustment taaki gap sahi rahe */
.id-right-panel {
    padding: 25px 20px 20px 35px !important;
}


	/* Premium Input Design */
.premium-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    padding: 10px;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.input-group label {
    font-size: 13px;
    font-weight: 600;
    color: #34495e;
    margin-left: 2px;
}

.premium-input {
    width: 100%;
    padding: 5px 3px;
    border: 1.5px solid #dcdde1;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.3s;
    outline: none;
    background: #fbfbfb;
}

.premium-input:focus {
    border-color: #1e3c72;
    background: #fff;
    box-shadow: 0 0 8px rgba(30, 60, 114, 0.15);
}

.full-row {
    grid-column: span 2;
}
        /* All your existing CSS Styles remain same */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .shake-effect { animation: shake 0.3s ease-in-out; border: 2px solid #e74c3c !important; background-color: #fceae9 !important; }
        :root { --grad-blue: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); --primary: #2c3e50; --secondary: #27ae60; --danger: #e74c3c; --accent: #2980b9; --gold: #f1c40f; }
 body { 
    font-family: 'Poppins', sans-serif; 
    background: #eef2f3; 
    margin: 0; 
    /* height: 100vh; ko delete kar dein */
    min-height: 100vh; /* Taaki background poora dikhe */
    display: flex; 
    flex-direction: column; 
    overflow-y: hidden;
}

/* Purane code mein flex-grow: 1 ko hata kar 0 kar dein */
.container { 
    width: 98% !important; 
    max-width: 1600px; 
    margin: 10px auto; 
    padding: 3px; 
    flex-grow: 0; /* Isse content stretch nahi hoga */
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}

/* Table wrapper ko window ke andar rakhne ke liye */
.table-wrapper-report {
    width: 98%;
    overflow-x: auto; /* Choti screen par table scroll ho window nahi */
    border-radius: 12px;
    border: 1px solid #dee2e6;
	
}

        header { display: flex; align-items: center; justify-content: center; gap: 20px; background: #121212; color: white; padding: 15px; border-radius: 15px; border-bottom: 4px solid #f1c40f; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .stats-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .stat-item { flex: 1; padding: 5px; border-radius: 20px; color: #f1c40f; text-align: center; font-weight: bold; background: linear-gradient(145deg, #1a1a1a, #000000); border: 1px solid #f1c40f; cursor: pointer; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 15px; }
        .menu-card { background: #ffffff; border: 1px solid #ddd; border-radius: 18px; padding: 25px 15px; text-align: center; cursor: pointer; transition: 0.3s; color: #2c3e50; font-weight: 700; }
        .menu-card:hover { background: linear-gradient(145deg, #1a1a1a, #000000) !important; color: #f1c40f !important; border-color: #f1c40f; transform: translateY(-5px); }
        .menu-card b { font-size: 45px; display: block; margin-bottom: 12px; }
        /* Sabhi sections ko scrollable banane ke liye */
.section-view {
    display: none;
    flex-direction: column;
    flex-grow: 1;
    height: 70vh; /* Screen ki fixed height taaki scrollbar trigger ho */
    overflow-y: auto !important; /* Vertical scrollbar enable karega */
    padding-right: 5px; /* Scrollbar aur table ke beech thoda gap */
    scrollbar-width: thin; /* Firefox ke liye premium look */
}

/* Chrome/Safari ke liye premium scrollbar styling */
.section-view::-webkit-scrollbar {
    width: 6px;
}
.section-view::-webkit-scrollbar-thumb {
    background: #34495e;
    border-radius: 10px;
}
.section-view::-webkit-scrollbar-track {
    background: #f1f1f1;
}

/* Dashboard scrollable area fix */
#dashboard-view {
    max-height: 75vh;
    overflow-y: auto;
    padding: 10px;
}
        .active-section { display: flex; }
        .table-wrapper { flex-grow: 1; overflow-y: auto; border-radius: 12px; background: white; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #34495e; color: white; padding: 10px; text-align: left; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        
		.btn-act {
    padding: 8px 15px; /* Fixed height ke bajaye padding use karein */
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: white;
    font-weight: bold;
    font-size: 13px;
    width: auto;       /* Button ko zarurat ke mutabik size lene dein */
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { background: white; width: 700px; margin: 4vh auto; padding: 8px; border-radius: 20px; max-height: 88vh; overflow-y: auto; position: relative; }
        .close-x { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; }
        footer { background: #1a252f; color: #ffffff; padding: 10px 50px; border-top: 4px solid #f1c40f; margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        
		
		
		
		.footer-class-name { /* Apne footer ki class ka naam yahan likhein */
    position: relative; 
    margin-top: 90px;
    clear: both;
}
        /* Premium Loader Styling */
#loader { 
    display:flex;
    position:fixed; 
    top:0; left:0; 
    width:100%; height:100%; 
    background: #ffffff; 
    z-index:20000; 
    flex-direction:column; 
    justify-content:center; 
    align-items:center; 
}

.loader-logo {
    width: 120px;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

/* Premium Black & Gold Login Screen */
#login-screen { 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    /* Deep Black Gradient */
    background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%); 
    display: none; 
    justify-content: center; 
    align-items: center; 
    z-index: 10000; 
}

.login-box { 
    background: rgba(20, 20, 20, 0.9); 
    backdrop-filter: blur(10px); 
    padding: 45px 35px; 
    border-radius: 25px; 
    width: 360px; 
    text-align: center; 
    /* Gold Border Glow */
    box-shadow: 0 0 30px rgba(241, 196, 15, 0.15), 0 15px 40px rgba(0,0,0,0.8); 
    border: 1px solid #f1c40f; /* Gold Border */
    position: relative;
    overflow: hidden;
}

/* Luxury Gloss Effect on Box */
.login-box::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(241, 196, 15, 0.05), transparent);
    transform: rotate(45deg);
    pointer-events: none;
}

.login-box h2 { 
    color: #f1c40f; /* Gold Title */
    font-weight: 600; 
    margin: 20px 0 25px 0; 
    letter-spacing: 2px;
    text-transform: uppercase;
    font-size: 20px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.brand-logo-login {
    width: 105px;
    height: 105px;
    background: #000;
    border-radius: 50%;
    padding: 3px;
    margin: 0 auto;
    border: 2px solid #f1c40f; /* Gold Circle */
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
}

.premium-input-login { 
    width: 100%; 
    padding: 15px; 
    margin: 12px 0; 
    border: 1px solid #333; 
    border-radius: 12px; 
    background: #111; /* Dark Input */
    box-sizing: border-box; 
    font-size: 15px; 
    color: #fff;
    transition: 0.3s;
}

.premium-input-login:focus { 
    border-color: #f1c40f; /* Gold focus */
    box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
    outline: none;
    background: #000;
}

/* Gold Button */
.btn-login-gold {
    background: linear-gradient(135deg, #d4af37 0%, #f1c40f 50%, #b8860b 100%);
    color: #000;
    width: 100%;
    padding: 15px;
    margin-top: 20px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
    transition: 0.4s;
    text-transform: uppercase;
}

.btn-login-gold:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(241, 196, 15, 0.5);
    filter: brightness(1.1);
}

.premium-footer {
    background: linear-gradient(180deg, #121212 0%, #000000 100%);
    padding: 5px 10px; /* Sahi spacing */
    border-top: 1px solid #d4af37;
    position: fixed; /* Screen ke niche chipka rahega */
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 2000;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
    box-sizing: border-box;
}

.footer-content {
    display: flex;
    justify-content: space-between; /* Brand Left, Version Center, Icons Right */
    align-items: center;
    max-width: 1300px;
    margin: 0 auto;
    flex-wrap: nowrap; /* Sab kuch ek line mein rahega */
}

.footer-brand {
    text-align: left; /* Text ko left side align rakhne ke liye */
    flex: 1; /* Space cover karne ke liye */
	min-width: 250px;
}

.footer-brand .line-1 {
    display: block; /* Isse ye line puri width legi aur upar rahegi */
    font-size: 10px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 2px; /* Thoda gap niche wali line se */
}

.footer-brand .line-2 {
    display: block; /* Isse brand name niche wali line mein aayega */
    color: #f1c40f; /* Gold Color */
    font-size: 16px;
    font-weight: 800;
    letter-spacing: 1px;
}

.footer-version {
    background: rgba(255, 255, 255, 0.05);
    color: #d4af37;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 11px;
    border: 1px solid rgba(212, 175, 55, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 20px;
}

.footer-social {
    display: flex;
    gap: 20px;
    flex: 1;
    justify-content: flex-end; /* Icons Right side mein chale jayenge */
}

.footer-social a {
    color: #f1c40f; /* Seedha Gold dikhega */
    font-size: 18px;
    transition: 0.3s ease;
}

.footer-social a:hover {
    transform: translateY(-3px);
    text-shadow: 0 0 10px #f1c40f;
}

/* Mobile responsive fix */
@media (max-width: 768px) {
    .footer-content {
        flex-direction: column;
        gap: 10px;
    }
    .premium-footer {
        position: relative; /* Mobile par overlap na ho */
    }
}
        .setting-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="loader">
    <img src="https://lh3.googleusercontent.com/p/AF1QipNa-hW8Df5eMcblrnc40uO-Wp1TLdupZlse_Gmk=s1360-w1360-h1020-rw" class="loader-logo" >
    <i class="fa fa-spinner fa-spin" style="font-size:30px; color:#1e3c72;"></i>
    <b style="margin-top:15px; color:#1e3c72; letter-spacing:1px;">Establishing Secure Connection...</b>
</div>

<div id="login-screen">
    <div class="login-box">
        <div class="brand-logo-login">
            <img id="brandLoginLogo" src="https://via.placeholder.com/60?text=MS" style="width:100%; border-radius:50%; object-fit: cover;">
        </div>
        <h2 id="loginLibName">Library Management</h2>
        
        <input type="text" id="userIn" class="premium-input-login" placeholder="Username">
        <input type="password" id="passIn" class="premium-input-login" placeholder="Password">
        
        <button onclick="handleLogin()" class="btn-login-gold">
            <i class="fa fa-lock-open"></i> Secure Access
        </button>
        
        <p id="loginMsg" style="color:#ff7675; font-size:13px; margin-top:15px; font-weight:bold;"></p>
        <div style="margin-top:20px; font-size:10px; color:#555; letter-spacing: 1px;">
            ¬© 2026 A MS TECHNOLOGY | DIGITAL ACCESS
        </div>
    </div>
</div>

<div class="container" id="main-container" style="display:none;">
<header style="position: relative;">
    <label for="logoIn" class="logo-holder">
        <img id="logoShow" src="https://via.placeholder.com/60?text=LOGO">
    </label>
    <div style="text-align: left;">
        <h1 style="margin:0;" class="blink-title">Library Management</h1>
        <div style="
        font-size: 13px; 
        color: #38ef7d; 
        font-weight: 600; 
        margin-top: -5px; 
        margin-left: 250px; 
        letter-spacing: 1px;
        text-transform: uppercase;">
        A MS Technologyüßë‚Äçüíª
    </div>
    </div>

    <button onclick="handleLogout()" style="position: absolute; right: 20px; top: 20px; background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">
        <i class="fa fa-sign-out-alt"></i> Logout
    </button>
</header>

    <div class="stats-bar">
    <div class="stat-item" onclick="openS('main')">STUDENTS <br> <span id="stat-std">0</span></div>   
    
    <div class="stat-item" onclick="openS('paid-reports')" style="border-color: #2ecc71; color: #2ecc71;">
        ALL TIME PAID <br> <span id="allTimeStat">‚Çπ0</span>
    </div>
     
    <div class="stat-item" onclick="openS('fee')">Fee Payment <br> <span id="stat-exp">üí∞</span></div>
</div>

  <div id="dashboard-view" class="dashboard-grid">
    <div class="menu-card" onclick="openS('main')"><b>üë•</b>Students List</div>
    <div class="menu-card" onclick="openS('fee')"><b>üí∞</b>Fee Payment</div>
    <div class="menu-card" onclick="openS('shift')"><b>‚è≥</b>Remaining Seats</div>
    <div class="menu-card" onclick="openS('reports')"><b>üìã</b>Pending Reports</div>
    <div class="menu-card" onclick="openS('ex-list')" style="border: 2px solid var(--secondary) !important;">
        <b style="color:var(--secondary)">üéì</b>Ex-Students List
    </div>
    
    <div class="menu-card" onclick="openS('expense')"><b>üìâ</b>Expenses</div>
    
    <div class="menu-card" onclick="openS('trash')" style="border: 2px dashed var(--danger) !important;">
        <b style="color:var(--danger)">üóëÔ∏è</b>Recycle Bin
    </div>
    
    <div class="menu-card" onclick="openS('lib-settings')"><b>‚öôÔ∏è</b>Settings</div>
</div>

    <div id="main-section" class="section-view">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
            <div style="display:flex; gap:10px;">
                <button onclick="clrF(); opMod('addModal', true)" style="background:var(--secondary);" class="btn-act">+ New Admission</button>
                <input type="text" id="srch" placeholder="Search..." onkeyup="drawMain()" style="padding:10px; border:1px solid #ddd; border-radius:8px; width:280px;">
            </div>
        </div>
        <div id="studentListContainer">
    <table class="myTable">
        <thead>
            <tr style="background: #34495e; color: white;">
                <th style="padding: 12px; text-align: left; width: 20%;">Name</th>
                <th style="padding: 12px; text-align: left; width: 20%;">Father</th>
                <th style="padding: 12px; text-align: left; width: 15%;">Mobile</th>
                <th style="padding: 12px; text-align: left; width: 15%;">Shift</th>
                <th style="padding: 12px; text-align: left; width: 10%;">Seat</th>
                <th style="padding: 12px; text-align: center; width: 20%;">Action</th>
            </tr>
        </thead>
        <tbody id="mainTbody">
            </tbody>
    </table>
</div>
    </div>
</div>
<div id="lib-settings-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        <h2 style="margin:0; color:var(--primary); font-size:24px;"><i class="fa fa-cog"></i> Library Settings</h2>
    </div>

    <div class="settings-premium-grid">
        <div class="settings-card">
            <h3 class="settings-card-title">Library Profile</h3>
            <div class="premium-form-grid">
                <div class="input-group">
                    <label>Library Name:</label>
                    <input type="text" id="setLibName" class="premium-input" placeholder="Enter Library Name">
                </div>
                <div class="input-group">
                    <label>Contact No:</label>
                    <input type="text" id="setLibContact" class="premium-input" placeholder="Enter Contact No">
                </div>
                <div class="input-group full-row">
                    <label>Library Address:</label>
                    <input type="text" id="setLibAddress" class="premium-input" placeholder="Enter Full Address">
                </div>
                <div class="input-group">
                    <label>Total Seats:</label>
                    <input type="number" id="setLibSeats" class="premium-input" placeholder="e.g. 100">
                </div>
                
                <div class="input-group logo-upload-container">
                    <label>Library Logo:</label>
                    <div class="logo-preview-wrapper" onclick="document.getElementById('setLogoIn').click()">
                        <img id="setLogoPreview" src="https://via.placeholder.com/80" alt="Logo">
                        <div class="logo-overlay"><i class="fa fa-camera"></i></div>
                    </div>
                    <input type="file" id="setLogoIn" style="display:none" onchange="previewSettingLogo(event)">
                    <button class="btn-act" style="background:var(--accent); margin-top:5px; padding: 5px 15px;" onclick="document.getElementById('setLogoIn').click()">Upload Image</button>
                </div>
            </div>
            <button onclick="saveLibProfile()" class="premium-btn-save" style="background:#2ecc71;">Update Profile</button>
        </div>

        <div class="settings-card">
            <h3 class="settings-card-title">Pin Settings</h3>
            <div class="input-group" style="margin-bottom:15px;">
                <label>Old PIN:</label>
                <input type="password" id="oldPin" class="premium-input" placeholder="Enter Old PIN">
            </div>
            <div class="input-group" style="margin-bottom:25px;">
                <label>New PIN:</label>
                <input type="password" id="newPin" class="premium-input" placeholder="Enter New PIN">
            </div>
            <button onclick="changePin()" class="premium-btn-save" style="background:#ff7675;">Change PIN</button>
            
            <div class="forgot-pin-box">
                Forgot Old PIN? Whatsapp me: <b>9918658008</b> <i>Your Software Partner üòä</i>
            </div>
        </div>
    </div>
</div>

<div id="ex-list-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding: 0 10px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary); padding: 8px 15px; height: fit-content;">
            ‚¨Ö Dashboard
        </button>
		<h2 style="margin:0; color:var(--primary); font-size:15px;">
            <i class="fa fa-graduation-cap"></i> Ex-Students List
        </h2>
        
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr style="background:#34495e; color:white;">
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Last Seat</th>
                    <th>Checkout Date</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="exStdTbody">
                </tbody>
        </table>
    </div>
</div>


<div id="reports-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        
        <div style="display:flex; gap:15px; align-items: flex-start;"> <div class="report-stat-card" style="border-left: 5px solid #e74c3c;">
        <small>TOTAL PENDING</small>
        <div id="valLeft">‚Çπ0</div> </div>
    <div class="report-stat-card" style="border-left: 5px solid #2ecc71;">
        <small>COLLECTED (MONTH)</small>
        <div id="valRight">‚Çπ0</div> </div>
        </div>
    </div>

    <div class="filter-bar-premium">
        <div style="display:flex; align-items:center; gap:8px;">
            <select id="penMonth" class="premium-input-small"></select>
            <select id="penYear" class="premium-input-small" ></select>
            
            <button onclick="drawPendingReport()" class="btn-premium-red">Show Pending List</button>
            <button onclick="downloadPendingPDF()" class="btn-premium-blue"><i class="fa fa-file-pdf"></i> PDF</button>
			
			<div class="badge-count">Total: <span id="penCount">0</span> Students</div>
        </div>
        <input type="text" id="reportSearch" placeholder="Search Name/Seat..." onkeyup="filterReportTable()" class="premium-input-search" style="width:200px;">
        
    </div>

    <div class="table-wrapper-report">
        <table id="reportTable">
            <thead>
                <tr style="background:#c0392b; color:white;">
                <th>Student Name</th>
                <th>Phone</th>
				<th>Seat No.</th>
                <th>Monthly Fee</th>
                <th>Pending</th>
                <th>Action</th> 
		</tr>
            </thead>
            <tbody id="penTbody"></tbody>
        </table>
    </div>
</div>

<div id="paid-reports-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        
        <div style="background:#27ae60; color:white; padding:5px 5px; border-radius:15px;">
            <small>SELECTED MONTH COLLECTION</small>
            <div id="monthlyPaidTotal" style="font-size:15px; font-weight:bold;">‚Çπ0</div>
        </div>
    </div>

    <div class="filter-bar-premium">
    <div style="display:flex; align-items:center; gap:8px;">
        <select id="paidMonth" class="premium-input-small"></select>
        <select id="paidYear" class="premium-input-small"></select>
        <button onclick="drawPaidReport()" class="btn-premium-blue">Filter Month</button>
		<button onclick="downloadPaidPDF()" class="btn-premium-red" style="background:#e74c3c;">
            <i class="fa fa-file-pdf"></i> Download PDF
        </button>
		<div class="badge-count">TOTAL STUDENTS: <span id="paidTxCount">0</span></div>
    </div>
    
</div>

    <div class="table-wrapper-report">
        <table>
            <thead>
                <tr style="background:#2c3e50; color:white;">
                    <th>Date</th>
                    <th>Student Name</th>
                    <th>Month-Year</th>
					<th>Monthly Fee</th>
                    <th>Receipt No</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="paidTbody"></tbody>
        </table>
    </div>
</div>


<div id="fee-section" class="section-view">
    <button onclick="goHome()" class="btn-act" style="background:var(--primary); margin-bottom:10px; width:fit-content;">‚¨Ö Dashboard</button>
    <div style="background:#f9f9f9; padding:20px; border-radius:15px; border:1px solid #ddd;">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:8px;">
            <div>
                <label style="font-weight:600; font-size:13px;">Select Shift:</label><br>
                <select id="fShft" onchange="loadStudentsByShift()" style="padding:10px; border-radius:8px; border:1px solid #ddd; width:220px;">
                    <option value="">-- Choose Shift --</option>
					
                    <option>Full Day</option>
                    <option>Morning (8 AM to 2 PM)</option>
                    <option>Afternoon (2 PM to 8 PM)</option>
                    <option>Night Shift</option>
                </select>
            </div>
            <div>
                <label style="font-weight:600; font-size:13px;">Select Seat No:</label><br>
                <select id="fSeat" style="padding:10px; border-radius:8px; border:1px solid #ddd; width:150px;">
                    <option value="">----</option>
                </select>
            </div>
            <button onclick="getStdForFee()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">
                <i class="fa fa-search"></i> Search Student
            </button>
        </div>

        <div id="fBox" style="display:none; background:white; padding:8px; border:1.5px dashed var(--accent); border-radius:12px; margin-top:5px;">
    <h3 id="fNameLabel" style="margin:0 0 8px 0; color:#1e3c72; border-bottom:1px solid #eee; padding-bottom:5px;"></h3>
    
    <div style="display:flex; gap:30px; background:#eef7ee; padding:10 px; border-radius:10px; width:50%; margin-bottom:15px;">
        <div><b style="color:#2c3e50;">Monthly Fee:</b> ‚Çπ<span id="lblFeeDisplay" style="font-size:18px; color:#27ae60;">0</span></div>
        <div id="historyLabel"><b>Last History:</b> <span id="lblLastPaid">Loading...</span></div>
    </div>

    <div style="display:flex; flex-direction: column; gap:15px;">
        <div style="display:flex; gap:10px; align-items:center;">
            <select id="pM" class="premium-input" style="width:120px;"></select>
            <select id="pY" class="premium-input" style="width:100px;"></select>
            <input type="number" id="pA" placeholder="Amount" class="premium-input" style="width:150px;">
        </div>
        
        <button onclick="qSave()" id="btnSubmitFee" style="background:var(--secondary); color:white; border:none; padding:7px; border-radius:10px; font-weight:bold; width:35%; cursor:pointer; font-size:16px;">
            <i class="fa fa-check-circle"></i> Submit Fee Now
        </button>
    </div>
</div>
    </div>
</div>

<div id="expense-section" class="section-view">
    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        <button onclick="downloadExExcel()" class="btn-act" style="background:#27ae60;">
            <i class="fa fa-file-excel"></i> Download Expense Excel
        </button>
    </div>

    <div style="background:#fff; padding:10px; border-radius:12px; margin-bottom:10px; display:flex; gap:15px; align-items:center; border:1px solid #ddd;">
        <div>
            <label style="font-size:12px; font-weight:bold;">From:</label>
            <input type="date" id="exFromDate" class="premium-input" style="width:140px; padding:3px;">
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">To:</label>
            <input type="date" id="exToDate" class="premium-input" style="width:140px; padding:3px;">
        </div>
        <button onclick="drawEx()" class="btn-act" style="background:var(--accent); margin-top:15px;">üîç Filter</button>
        <button onclick="resetExFilter()" class="btn-act" style="background:#95a5a6; margin-top:15px;">Reset</button>
        
        <div style="margin-left:auto; background:#f1c40f; color:#000; padding:8px 20px; border-radius:10px; text-align:right;">
            <small style="display:block; font-size:10px; font-weight:bold;">TOTAL EXPENSE</small>
            <span id="totalExDisplay" style="font-size:18px; font-weight:800;">‚Çπ0</span>
        </div>
    </div>

    <div style="background:white; padding:8px; border-radius:15px; margin-bottom:7px; display:flex; gap:10px; border:1px solid #eee;">
        <input type="text" id="exReason" placeholder="Reason..." style="flex:2; padding:8px; border:1px solid #ddd; border-radius:8px;">
        <input type="number" id="exAmt" placeholder="Amount" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px;">
        <button onclick="addExpense()" style="background:var(--danger); color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer;">
            + Add Expense
        </button>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr style="background:#34495e; color:white;">
                    <th>Date</th>
                    <th>Reason</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="exTbody"></tbody>
        </table>
    </div>
</div>

<div id="trash-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:7px;">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        
        <div style="font-size:16px; color:var(--danger);">üóëÔ∏è Recycle Bin (Trash)</div>
    </div>
    
    <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #34495e; color: white;">
                    <th style="padding: 8px; width: 15%;">Type</th>
                    <th style="padding: 8px; width: 40%;">Details</th>
                    <th style="padding: 8px; width: 20%;">Deleted Date</th>
                    <th style="padding: 8px; width: 25%; text-align: center;">Action</th>
                </tr>
            </thead>
            <tbody id="trashTbody">
                </tbody>
        </table>
    </div>
</div>



<div id="addModal" class="modal">
    <div class="modal-content" style="width: 750px; border-radius: 25px; padding: 10px;">
        <span class="close-x" onclick="opMod('addModal', false)">√ó</span>
        <h2 style="color:#1e3c72; border-bottom: 2px solid #f1c40f; padding-bottom: 3px; margin-bottom: 10px;">
            <i class="fa fa-user-plus"></i> New Student Admission
        </h2>

        <div style="display: flex; gap: 40px;">
            <div class="premium-form-grid" style="flex: 2;">
                <input type="hidden" id="eid">
                
                <div class="input-group">
                    <label>Student Name</label>
                    <input type="text" id="n" placeholder="Enter Full Name" class="premium-input">
                </div>
                
                <div class="input-group">
                    <label>Father's Name</label>
                    <input type="text" id="fn" placeholder="Enter Father's Name" class="premium-input">
                </div>

                <div class="input-group">
                    <label>Mother's Name</label>
                    <input type="text" id="mn" placeholder="Enter Mother's Name" class="premium-input">
                </div>

                <div class="input-group">
                    <label>Mobile Number</label>
                    <input type="text" id="p" placeholder="Primary Contact" class="premium-input">
                </div>

                <div class="input-group">
                    <label>Emergency Contact</label>
                    <input type="text" id="en" placeholder="Emergency No." class="premium-input">
                </div>

                <div class="input-group">
                    <label>Seat Number</label>
                    <input type="text" id="st" placeholder="E.g. 15" class="premium-input">
                </div>

                <div class="input-group">
                    <label>Select Shift</label>
                    <select id="sh" class="premium-input" style="height: 32px;">
                        <option>Full Day</option>
                        <option>Morning (8 AM to 2 PM)</option>
                        <option>Afternoon (2 PM to 8 PM)</option>
                        <option>Night Shift</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Monthly Fee (‚Çπ)</label>
                    <input type="number" id="rt" placeholder="Amount" class="premium-input">
                </div>

                <div class="input-group full-row">
                    <label>Full Address</label>
                    <input type="text" id="ad" placeholder="Village, Post, Dist" class="premium-input">
                </div>
            </div>

            <div style="flex: 0.8; text-align: center; border-left: 1px dashed #ddd; padding-left: 30px;">
                <label style="font-weight: 600; display: block; margin-bottom: 15px;">Student Photo</label>
                <div onclick="document.getElementById('stdPhotoIn').click()" 
                     style="width: 200px; height: 240px; border: 2px dashed #1e3c72; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fdfdfd; cursor: pointer; position: relative;">
                    <img id="formPhotoPreview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <div id="uploadTxt" style="color: #1e3c72; font-size: 14px;">
                        <i class="fa fa-camera fa-2x"></i><br><b>Browse Photo</b>
                    </div>
                </div>
                <input type="file" id="stdPhotoIn" style="display:none" onchange="previewPremiumPhoto(event)" accept="image/*">
                <p style="font-size: 11px; color: #e74c3c; margin-top: 15px;">
                    <i class="fa fa-info-circle"></i> Max File Size: <b>25 KB</b>
                </p>
            </div>
        </div>

        <button onclick="saveStd()" style="background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color:white; width:50%; padding:8px; border:none; border-radius:15px; margin-top:18px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(30, 60, 114, 0.2);">
            <i class="fa fa-save"></i> Save Admission
        </button>
    </div>
</div>

<div id="pinModal" class="modal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal-content" style="width: 320px; text-align: center; padding: 25px; border-radius: 20px;">
        <h3 style="margin-top:0; color:#1e3c72;"><i class="fa fa-lock"></i> Security Check</h3>
        <p style="font-size: 13px; color: #666;">Enter 4-digit transaction pin</p>
        
        <input type="password" id="customPinInput" 
               style="width: 80%; padding: 12px; font-size: 24px; text-align: center; letter-spacing: 8px; border: 2px solid #ddd; border-radius: 10px; margin: 15px 0;" 
               maxlength="4" placeholder="****">
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="closePinModal()" class="btn-act" style="background:#bdc3c7; flex:1;">Cancel</button>
            <button onclick="verifyAndProcessFee()" class="btn-act" style="background:#27ae60; flex:1;">Verify</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal" style="display:none; align-items:center; justify-content:center; z-index: 2000;">
    <div class="modal-content" style="width: 300px; text-align: center; padding: 30px; border-radius: 20px; border-top: 5px solid #27ae60;">
        <div style="font-size: 50px; color: #27ae60; margin-bottom: 15px;">
            <i class="fa fa-check-circle"></i>
        </div>
        <h3 style="margin: 0; color: #2c3e50;">Success!</h3>
        <p style="color: #666; margin: 10px 0 20px 0;">Fee paid successfully.</p>
        <button onclick="closeSuccessModal()" class="btn-act" style="background:#27ae60; width: 100%; padding: 12px; border-radius: 10px;">Ok</button>
    </div>
</div>

<div id="logoutModal" class="modal" style="display:none; align-items:center; justify-content:center; z-index: 3000;">
    <div class="modal-content" style="width: 320px; text-align: center; padding: 25px; border-radius: 20px; border-top: 5px solid #e74c3c;">
        <div style="font-size: 50px; color: #e74c3c; margin-bottom: 15px;">
            <i class="fa fa-sign-out-alt"></i>
        </div>
        <h3 style="margin: 0; color: #2c3e50;">Confirm Logout</h3>
        <p style="color: #666; margin: 10px 0 20px 0;">Are you sure want to logout??</p>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeLogoutModal()" class="btn-act" style="background:#bdc3c7; flex:1; padding: 10px; border-radius: 10px;">Cancel</button>
            <button onclick="executeLogout()" class="btn-act" style="background:#e74c3c; flex:1; padding: 10px; border-radius: 10px;">Logout</button>
        </div>
    </div>
</div>

<div id="profModal" class="modal">
    <div class="modal-content" style="width: 750px; border-radius: 15px;">
        <span class="close-x" onclick="opMod('profModal', false)">√ó</span>
        <h2 style="margin:0; color:var(--primary); font-size: 22px;">Student Profile Ledger</h2>
        
        <div style="background: #fff5f5; border: 2px dashed #ff4757; padding: 3px; border-radius: 8px; margin: 15px 0; display: flex; align-items: center; justify-content: width:50%; space-between;">
            <b style="color:#e74c3c;">Mark as Ex-Student? if student seat is free currently</b>
            <input type="checkbox" id="exCheck" style="width:20px; height:20px; cursor:pointer;" onchange="markAsExStudent()">
        </div>

        <div id="sData" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; background:#f8f9fa; padding:8px; border-radius:12px; border: 2px solid #eee;">
            </div>

        <button onclick="tglID()" class="btn-act" style="background:var(--accent); padding: 10px 15px; margin-bottom: 15px;">
            <i class="fa fa-id-card"></i> Identity Card
        </button>

<div id="idV" class="id-card-premium-landscape" style="display:none;">
    <div class="id-left-panel">
        <div class="logo-circle">
            <img id="idLogoPreviewNew" src="https://via.placeholder.com/80" style="width:100%; border-radius:50%;">
        </div>
        <div class="lib-info">
            <b id="idLibNameNew" style="font-size: 14px; color: #ff0000;">PATEL DIGITAL LIBRARY</b><br>
            <span id="idLibAddrNew">Gausganj, Hardoi</span><br>
            <span id="idLibMobNew">Mob: 9918658008</span>
        </div>

        <div class="id-details-left">
            <div class="label-box">FATHER'S NAME</div>
            <div class="value-text" id="idFatherNew">-</div>

            <div class="label-box">DATE OF JOINING</div>
            <div class="value-text" id="idDateNew">-</div>
        </div>
    </div>

    <div class="id-right-panel">
    <h2 class="student-name-big" id="idStdNameNew">STUDENT NAME</h2>
    
    <div class="id-row">
        <div class="info-item">
            <b>SHIFT</b>
            <span id="idShiftNew">-</span>
        </div>
        <div class="info-item">
            <b>SEAT NO</b>
            <span id="idSeatNew">-</span>
        </div>
    </div>
     <div class="id-address-block">
        <b>EM-CONTACT NO</b>
        <p id="idEmergencyNew" style="color: #1a1a1a; font-weight: 600; font-size: 12px; margin: 0;">-</p>
    </div>
    <div class="id-address-block">
        <b>ADDRESS</b>
        <p id="idFinalAddress" style="color: #1a1a1a; font-weight: 600; font-size: 12px; margin: 0;">-</p>
    </div>

    <div class="photo-holder">
        <img id="idPhotoNew" style="display:none;">
        <span id="phTxNew" style="color:#ccc; font-size:12px;">PHOTO</span>
    </div>
</div>

    <div class="id-footer-strip"></div>
</div>

        <div class="table-wrapper" style="max-height: 250px;">
            <table style="width:100%;">
                <thead style="background:#34495e; color:white;">
                    <tr><th>Month/Year</th><th>Date</th><th>Receipt No</th><th>Amount</th></tr>
                </thead>
                <tbody id="sBody"></tbody>
            </table>
        </div>

        <div style="text-align:right; margin-top:10px; font-weight:bold; background:var(--grad-orange); color:white; padding:10px; border-radius:8px;">
            Total Paid: ‚Çπ<span id="sPd">0</span>
        </div>

        <button onclick="genPDF()" style="background:var(--grad-blue); color:white; width:100%; padding:15px; border:none; margin-top:15px; font-weight:bold; border-radius:10px; cursor:pointer;">
            <i class="fa fa-download"></i> Full Statement PDF
        </button>
    </div>
</div>

<div id="shift-section" class="section-view">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; background:#fff; padding:5px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
        <button onclick="goHome()" class="btn-act" style="background:var(--primary)">‚¨Ö Dashboard</button>
        <div style="display:flex; gap:15px; align-items:center;">
            <b style="color:var(--primary)">Select Shift:</b>
            <select id="shftSel" onchange="drawShft()" class="premium-input" style="width:200px; padding:8px;">
                <option>Select</option>
				<option>Full Day</option>
                <option>Morning (8 AM to 2 PM)</option>
                <option>Afternoon (2 PM to 8 PM)</option>
                <option>Night Shift</option>
            </select>
        </div>
        <div style="background:linear-gradient(135deg, #1e3c72 10%, #2a5298 100%); color:white; padding:1px 15px; border-radius:30px; text-align:center;">
            <small style="display:block; font-size:12px; opacity:0.8;">AVAILABLE SEATS</small>
            <span id="shftCount" style="font-size:18px; font-weight:bold; color:#38ef7d;">0</span>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr style="background: #34495e; color: white;">
                    <th style="padding: 5px; width: 10%;">Seat No.</th>
                    <th style="padding: 5px; width: 20%;">Status</th>
                    <th style="padding: 5px; width: 40%;">Occupied By (Name)</th>
                    <th style="padding: 5px; width: 30%;">Current Shift</th>
                </tr>
            </thead>
            <tbody id="shftTbody"></tbody>
        </table>
    </div>
</div>



<footer class="premium-footer">
    <div class="footer-content">
        <div class="footer-brand">
            <span class="line-1">Developed & Powered by</span>
            <span class="line-2">A MS TECHNOLOGY üßë‚Äçüíª</span>
        </div>

        <div class="footer-version">
            <span class="pulse-dot"></span> System Ver 1.0.0
        </div>

        <div class="footer-social">
            <a href="https://wa.me/919918658008" target="_blank" title="WhatsApp Support">
                <i class="fab fa-whatsapp"></i>
            </a>
            <a href="https://www.instagram.com/manendra.patel_ms/" target="_blank" title="Instagram">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://www.mspatelcomputers.com" title="Website">
                <i class="fas fa-globe"></i>
            </a>
			<a href="https://www.facebook.com/patelcomputers.ms/" title="facebook">
                <i class="fas fa-square-facebook"></i>
            </a>
        </div>
    </div>
</footer>
<script>
// --- Global Variables ---
let db = [], tr = [], ex = [], exStd = [], cur = null;
const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// 1. Firebase Configuration (Don't change this)
const firebaseConfig = {
    apiKey: "AIzaSyCoJ1n6PjjEgFaugMxdSFhe5bOahSMRBSI",
    authDomain: "ms-library-management.firebaseapp.com",
    databaseURL: "https://ms-library-management-default-rtdb.firebaseio.com",
    projectId: "ms-library-management",
    storageBucket: "ms-library-management.firebasestorage.app",
    messagingSenderId: "384647074793",
    appId: "1:384647074793:web:dc5ade240f118e95abf178"
};

firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

function handleLogin() {
    const u = document.getElementById('userIn').value.trim();
    const p = document.getElementById('passIn').value.trim();
    const msg = document.getElementById('loginMsg');
    const loader = document.getElementById('loader');

    // --- AAPKI COMPANY KA FIXED LOGO LINK ---
    const companyLogo = "https://lh3.googleusercontent.com/p/AF1QipNa-hW8Df5eMcblrnc40uO-Wp1TLdupZlse_Gmk=s1360-w1360-h1020-rw"// Yahan apna asli logo URL dalein

    if (!u || !p) {
        msg.innerText = "‚ùå Please enter username and password!";
        return;
    }

    // Loader aur Logo Sync
    loader.style.display = 'flex';
    if(document.getElementById('brandLoaderLogo')) document.getElementById('brandLoaderLogo').src = companyLogo;
    if(document.getElementById('brandLoginLogo')) document.getElementById('brandLoginLogo').src = companyLogo;

    // Firebase Auth logic
    rdb.ref('library_data/Users').once('value').then((snap) => {
        const users = snap.val();
        let foundUid = null;

        if (users) {
            for (let uid in users) {
                if (users[uid][u] !== undefined && users[uid][u] == p) {
                    foundUid = uid;
                    break;
                }
            }
        }

        if (foundUid) {
            localStorage.setItem('uid', foundUid);
            localStorage.setItem('isLoggedIn', 'true');
            document.getElementById('login-screen').style.display = 'none';
            loadAllLibraryData(); 
        } else {
            loader.style.display = 'none';
            msg.innerText = "‚ùå Invalid Username or Password!";
            const box = document.querySelector('.login-box');
            box.classList.add('shake-effect');
            setTimeout(() => box.classList.remove('shake-effect'), 500);
        }
    }).catch(err => {
        loader.style.display = 'none';
        msg.innerText = "‚ö†Ô∏è Connection Error!";
    });
}

function loadAllLibraryData() {
    const uid = localStorage.getItem('uid');
    const loader = document.getElementById('loader');
    const mainContainer = document.getElementById('main-container');

    if(!uid) return;

    // --- STEP 1: INSTANT LOAD FROM CACHE ---
    // Browser memory se check karo agar pehle ka data pada hai
    const cachedData = localStorage.getItem(`cache_data_${uid}`);
    if (cachedData) {
        const data = JSON.parse(cachedData);
        db = data.students || [];
        ex = data.expenses || [];
        tr = data.trash || [];
        exStd = data.exStudents || [];
        
        drawMain(); // Table turant bhar jayegi
        loader.style.display = 'none'; // Loader turant hat jayega
        mainContainer.style.display = 'flex'; // Dashboard turant dikhega
    }

    // --- STEP 2: BACKGROUND SYNC WITH FIREBASE ---
    // Firebase se naya data fetch karo (Ye background mein hota rahega)
    rdb.ref(`library_data/Users/${uid}/data`).on('value', (snap) => {
        const data = snap.val() || {};
        
        // Memory (Cache) ko naye data se update karo
        localStorage.setItem(`cache_data_${uid}`, JSON.stringify(data));

        // Variables ko naye data se bharo
        db = data.students || [];
        ex = data.expenses || [];
        tr = data.trash || [];
        exStd = data.exStudents || [];
        
        drawMain(); // Agar DB mein koi badlav hua hai toh screen apne aap update ho jayegi
        
        // Loader hide aur Container show (Security backup agar cache khali ho)
        loader.style.display = 'none';
        mainContainer.style.display = 'flex';
    });

    // Dashboard Stats (All Time Paid) Load
    rdb.ref(`library_data/Users/${uid}/collections`).on('value', (snap) => {
        const collections = snap.val();
        let total = 0;
        if (collections) {
            Object.values(collections).forEach(tx => {
                total += parseFloat(tx.amount || 0);
            });
        }
        const statEl = document.getElementById('allTimeStat');
        if(statEl) statEl.innerText = '‚Çπ' + total.toLocaleString();
    });

    loadSettings();
    initializeDropdowns();
}


function saveStd() {
    const id = document.getElementById('eid').value;
    const st = document.getElementById('st').value.trim(); 
    const sh = document.getElementById('sh').value;      
    const name = document.getElementById('n').value.trim();

    if (!name || !st) {
        alert("Student Name and Seat Number is mandatory!");
        return;
    }

    // Seat Conflict Validation
    const conflict = db.find(s => {
        if (id && s.id == id) return false;
        if (s.seat == st) {
            if (sh === "Full Day" && (s.shift === "Full Day" || s.shift.includes("Morning") || s.shift.includes("Afternoon"))) return true;
            if ((sh.includes("Morning") || sh.includes("Afternoon")) && (s.shift === "Full Day" || s.shift === sh)) return true;
            if (sh === "Night Shift" && s.shift === "Night Shift") return true;
        }
        return false;
    });

    if (conflict) {
        alert(`üö® Seat Conflict! Seat No. ${st} is already occupied.`);
        return;
    }

    // --- DATA PREPARATION: PURANA DATA FETCH KAREIN ---
    let oldFeeHistory = [];
    let oldFeeObject = {};
    let finalId = id ? parseInt(id) : Date.now();

    // Check karein agar ye Re-admission hai
    if (window.pendingReAdmissionId) {
        const sourceStudent = exStd.find(s => s.id === window.pendingReAdmissionId);
        if (sourceStudent) {
            oldFeeHistory = sourceStudent.feeHistory || [];
            oldFeeObject = sourceStudent.fee || {};
            finalId = sourceStudent.id; // Purani ID hi rakhein
        }
    }

    const sData = {
        id: finalId,
        name: name,
        father: document.getElementById('fn').value || '',
        mother: document.getElementById('mn').value || '',
        phone: document.getElementById('p').value || '',
        emergency: document.getElementById('en').value || '',
        seat: st,
        shift: sh,
        rt: document.getElementById('rt').value || 0,
        address: document.getElementById('ad').value || '',
        photo: document.getElementById('formPhotoPreview').src.startsWith('data:image') ? document.getElementById('formPhotoPreview').src : '',
        date: new Date().toLocaleDateString('en-IN'),
        feeHistory: oldFeeHistory, 
        fee: oldFeeObject
    };

    // --- SAVE & SYNC ---
    if(id) {
        const idx = db.findIndex(x => x.id == id);
        db[idx] = sData;
    } else {
        db.push(sData);
        // Agar Re-admission tha, toh Ex-list se delete karein
        if (window.pendingReAdmissionId) {
            exStd = exStd.filter(student => student.id !== window.pendingReAdmissionId);
            window.pendingReAdmissionId = null; 
        }
    }

    sync(); 
    opMod('addModal', false);
    clrF();
    
    alert("‚úÖ Admission Successful! Student list updated.");
    drawMain();
    if(typeof drawExStudents === "function") drawExStudents();
}

function previewPremiumPhoto(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('formPhotoPreview');
    const uploadTxt = document.getElementById('uploadTxt');

    if (file) {
        // Validation: 25KB check (Aapke UI ke hisab se)
        if (file.size > 25600) { 
            alert("üö® Photo size is more than 25KB .");
            event.target.value = ''; 
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            // Preview element ko source dena
            preview.src = e.target.result;
            
            // UI Changes: Image dikhao aur "Browse" text chhupao
            preview.style.display = 'block';
            if (uploadTxt) uploadTxt.style.display = 'none';
            
            console.log("Photo loaded successfully!"); // Debugging ke liye
        }
        reader.readAsDataURL(file);
    }
}

function markAsExStudent() {
    const chk = document.getElementById('exCheck');
    if (!chk.checked) return;

    if (confirm("Are you want to Checkout (Ex-Student)? Seat will be free.")) {
        // 'cur' global variable hai jo viewS() mein set hota hai
        let index = db.findIndex(s => s.id === cur);
        
        if (index > -1) {
            // Data ko student list se nikalna
            let studentData = db.splice(index, 1)[0]; 

            // Checkout details add karna
            studentData.checkoutDate = new Date().toLocaleDateString();
            studentData.status = "Ex-Student";

            // Sabse important: Agar exStd array nahi bana hai toh banayein
            if (!window.exStd) window.exStd = [];
            
            // Ex-Student list mein daalna
            exStd.push(studentData);

            // Cloud aur UI Update
            sync(); 
            opMod('profModal', false);
            drawMain(); // Student list refresh
            
            alert("‚úÖ Student moved in Ex-Student List.");
        }
    } else {
        chk.checked = false;
    }
}

function drawPendingReport() {
    const m = document.getElementById('penMonth').value;
    const y = document.getElementById('penYear').value;
    if (!m || !y) {
        alert("Please select Month and Year!");
        return;
    }

    const libName = document.getElementById('setLibName')?.value || "Our Library";
    const libAddr = document.getElementById('setLibAddress')?.value || "";
    const libMob = document.getElementById('setLibContact')?.value || "";

    const targetKey = `${m}-${y}`;
    const tb = document.getElementById('penTbody');
    tb.innerHTML = '';

    let totalPendingAll = 0, totalCollAll = 0, count = 0;

    db.forEach(s => {
        const fixedMonthlyFee = parseFloat(s.rt || 0);
        
        let totalPaidInThisMonth = 0;
        if (s.feeHistory) {
            totalPaidInThisMonth = s.feeHistory
                .filter(tx => tx.monthYear === targetKey)
                .reduce((sum, tx) => sum + parseFloat(tx.amount || 0), 0);
        }

        const remainingAmt = fixedMonthlyFee - totalPaidInThisMonth;

        // Sirf wahi dikhayein jinka balance baki hai
        if (remainingAmt > 0) {
            count++;
            totalPendingAll += remainingAmt;
            totalCollAll += totalPaidInThisMonth; // Is month ka collection bhi add karein

            // Message Format
            const msg = `Dear *${s.name}*, üëã\n\n` +
                        `Friendly reminder regarding library fee for *${m}-${y}*. üìö\n\n` +
                        `üìå *Fee Details:*\n` +
                        `- Monthly Fee: ‚Çπ${fixedMonthlyFee}\n` +
                        `- Amount Paid: ‚Çπ${totalPaidInThisMonth}\n` +
                        `- *Pending: ‚Çπ${remainingAmt}* üí≥\n\n` +
                        `Kindly clear your dues. ‚è≥\n\n` +
                        `‚ú® ${libName} \n` +
                        `üìç ${libAddr}\n` +
                        `üìû ${libMob}`;
			const encodedMsg = encodeURIComponent(msg);
            const waUrl = `https://api.whatsapp.com/send?phone=91${s.phone}&text=${encodedMsg}`;

            tb.innerHTML += `
                <tr class="report-row">
                    <td><b>${s.name}</b></td>
                    <td>${s.phone}</td>
                    <td><span class="badge-seat">${s.seat}</span></td>
                    <td>‚Çπ${fixedMonthlyFee}</td>
                    <td>
                        <div style="line-height:1.4;">
                            <span class="paid-val" style="color:#27ae60; font-weight:bold; font-size:12px;">Paid: ‚Çπ${totalPaidInThisMonth}</span><br>
                            <span class="pending-val" style="color:#e74c3c; font-weight:bold; font-size:13px;">Due: ‚Çπ${remainingAmt}</span>
                        </div>
                    </td>
                    <td>
                        <div class="action-btn-group">
                            <a href="tel:${s.phone}" class="premium-btn btn-call"><i class="fa fa-phone"></i></a>
							<a href="${waUrl}" target="_blank" class="premium-btn btn-wa"><i class="fab fa-whatsapp"></i> Notify</a>
                            <button onclick="quickPay('${s.shift}', '${s.seat}')" class="premium-btn btn-pay"><i class="fa fa-credit-card"></i> Pay</button>
                            
                        </div>
                    </td>
                </tr>`;
        }
    });

    // Dashboard Stats Update
    if(document.getElementById('valLeft')) document.getElementById('valLeft').innerText = '‚Çπ' + totalPendingAll.toLocaleString();
    if(document.getElementById('valRight')) document.getElementById('valRight').innerText = '‚Çπ' + totalCollAll.toLocaleString();
    if(document.getElementById('penCount')) document.getElementById('penCount').innerText = count;
}

// Quick Pay Logic to jump to Fee Section
function quickPay(shift, seat) {
    openS('fee'); // Fee section open karein
    document.getElementById('fShft').value = shift;
    loadStudentsByShift(); // Seats load karein
    setTimeout(() => {
        document.getElementById('fSeat').value = seat;
        getStdForFee(); // Student data load karein
    }, 200);
}


function drawPaidReport() {
    const uid = localStorage.getItem('uid');
    const m = document.getElementById('paidMonth').value;
    const y = document.getElementById('paidYear').value;
    
    if (!m || !y) return;

    const targetKey = `${m}-${y}`;
    const tb = document.getElementById('paidTbody');
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center;">Filtering Full Paid Records...</td></tr>';

    rdb.ref(`library_data/Users/${uid}/collections`).once('value').then((snap) => {
        const collections = snap.val();
        tb.innerHTML = '';
        let monthTotal = 0;
        let studentCount = 0;
        let groupedData = {}; 

        if (collections) {
            Object.values(collections).forEach(tx => {
                if (tx.monthYear === targetKey) {
                    const sId = tx.studentId || tx.studentName;
                    
                    if (!groupedData[sId]) {
                        // DB (Active) aur Ex-Student dono mein check karein
                        let studentObj = db.find(std => std.id == tx.studentId) || 
                                       exStd.find(std => std.id == tx.studentId);
                        
                        groupedData[sId] = {
                            date: tx.date,
                            name: tx.studentName,
                            month: tx.monthYear,
                            monthlyFee: studentObj ? parseFloat(studentObj.rt || 0) : 0,
                            totalAmt: 0,
                            receipts: [],
                            isDeleted: !studentObj // Agar student dono list mein nahi hai
                        };
                    }
                    groupedData[sId].totalAmt += parseFloat(tx.amount || 0);
                    groupedData[sId].receipts.push(tx.receipt);
                }
            });
        }

        Object.values(groupedData).forEach(data => {
            // LOGIC: Sirf Full Paid dikhayein 
            // 1. Agar student active hai toh Total >= Monthly Fee honi chahiye
            // 2. Agar student delete ho chuka hai (isDeleted), toh hum use dikhayenge kyunki uska hisab khatam ho gaya
            if (data.isDeleted || data.totalAmt >= data.monthlyFee) {
                studentCount++;
                monthTotal += data.totalAmt;

                tb.innerHTML += `
                    <tr>
                        <td>${data.date}</td>
                        <td>
                            <b>${data.name}</b> 
                            ${data.isDeleted ? '<small style="color:gray;">(Removed)</small>' : ''}
                        </td>
                        <td>${data.month}</td>
						<td style="color:#2c3e50; font-weight:bold;">‚Çπ${data.monthlyFee}</td> 
						<td style="font-size:11px; color:#555;">${data.receipts.join(', ')}</td>
                        
                        <td style="color:#27ae60; font-weight:bold;">‚Çπ${data.totalAmt}</td>
                    </tr>`;
            }
        });
 
        document.getElementById('monthlyPaidTotal').innerText = '‚Çπ' + monthTotal.toLocaleString();
        document.getElementById('paidTxCount').innerText = studentCount;

        if (studentCount === 0) {
            tb.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">No full-paid records found.</td></tr>';
        }
    });
}


function updateReportStats(lVal, rVal, count) {
    // Check karein ki IDs exist karti hain ya nahi
    const left = document.getElementById('penTotalAmt');
    const right = document.getElementById('collTotalAmt');
    
    if(left) left.innerText = '‚Çπ' + lVal.toLocaleString();
    if(right) right.innerText = '‚Çπ' + rVal.toLocaleString();
    if(document.getElementById('penCount')) document.getElementById('penCount').innerText = count;
}

// Unified Filter (Stats ko nahi chedega)
function filterReportTable() {
    const q = document.getElementById('reportSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.report-row');
    rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(q) ? "" : "none";
    });
}
function drawShft() {
    const tb = document.getElementById('shftTbody');
    const selectedShift = document.getElementById('shftSel').value;
    const totalSeats = parseInt(document.getElementById('setLibSeats')?.value) || 50; 
    
    tb.innerHTML = '';
    let availableCount = 0;

    for (let i = 1; i <= totalSeats; i++) {
        const seatNo = i.toString();
        
        // Check karein ki kya is seat par koi student hai rules ke hisab se
        let occupant = db.find(s => {
            if (s.seat != seatNo) return false;
			
			
            if (selectedShift === "Full Day") {
                return (s.shift === "Full Day" || s.shift.includes("Morning") || s.shift.includes("Afternoon"));
            } else if (selectedShift === "Night Shift") {
                return (s.shift === "Night Shift");
            } else {
                return (s.shift === "Full Day" || s.shift === selectedShift);
            }
        });

        // AGAR SEAT KHALI HAI (No Occupant), SIRF TABHI TABLE MEIN DIKHAYEIN
        if (!occupant) {
            availableCount++;
            tb.innerHTML += `
                 <tr>
                    <td style="text-align:center; padding: 8px;"><b>${seatNo}</b></td>
                    <td style="padding: 8px;"><span class="badge-available">AVAILABLE</span></td>
                    <td style="color:#27ae60; font-weight:500; padding: 8px;">Ready to Assign</td>
                    <td style="color:#888; padding: 8px;">${selectedShift}</td>
                </tr>`;
        }
        // Occupied seats wala 'else' block maine hata diya hai taaki wo list mein na aayein
    }

    // Count update karein
    document.getElementById('shftCount').innerText = availableCount;

    // Agar koi bhi seat khali nahi hai toh message dikhayein
    if (availableCount === 0) {
        tb.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:15px; color:#e74c3c; font-weight:bold;">Is shift mein koi seat khali nahi hai!</td></tr>`;
    }
}

// Settings mein logo preview karne ke liye
function previewSettingLogo(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Logo = e.target.result;
            document.getElementById('setLogoPreview').src = base64Logo;
            document.getElementById('logoShow').src = base64Logo; // Header logo turant badalne ke liye
            localStorage.setItem('lib_main_logo', base64Logo); // Permanent save
        }
        reader.readAsDataURL(file);
    }
}


function saveLibProfile() {
    // 1. Form se values uthana
    const name = document.getElementById('setLibName').value;
    const contact = document.getElementById('setLibContact').value;
    const address = document.getElementById('setLibAddress').value;
    const seats = document.getElementById('setLibSeats').value;
    const logo = localStorage.getItem('lib_main_logo'); // Local storage se logo lena

    // 2. Data object taiyar karna
    const profileData = {
        libName: name,
        contact: contact,
        address: address,
        totalSeats: seats,
        logo: logo
    };

    const uid = localStorage.getItem('uid');
    if(uid) {
        // 3. Firebase mein data save karna
        rdb.ref(`library_data/Users/${uid}/settings`).set(profileData)
        .then(() => {
            // --- FIX: Yahan se location.reload() hata diya gaya hai ---
            
            // 4. Header aur UI ko turant update karna (Bina page refresh kiye)
            if(document.getElementById('logoShow')) document.getElementById('logoShow').src = logo;
            
            // Settings load karna taaki global variables update ho jayein
            loadSettings(); 
            
            // 5. Success Message dikhana (Professional Modal)
            const successMod = document.getElementById('successModal');
            if(successMod) {
                successMod.style.display = 'flex';
                // Success message text badalna (Optional)
                const msgPara = successMod.querySelector('p');
                if(msgPara) msgPara.innerText = "Library Profile & Address Updated Successfully!";
            } else {
                alert("‚úÖ Library Profile Updated!");
            }
            
            console.log("Profile updated.");
        })
        .catch(err => {
            console.error("Update Error:", err);
            alert("‚ö†Ô∏è Error: " + err.message);
        });
    } else {
        alert("üö® User session expired. Please login again.");
    }
}


function loadSettings() {
    const uid = localStorage.getItem('uid');
    if(uid) {
        rdb.ref(`library_data/Users/${uid}/settings`).once('value').then((snap) => {
            const s = snap.val();
            if(s) {
                // 1. Settings Form Inputs Fill Karein
                if(document.getElementById('setLibName')) document.getElementById('setLibName').value = s.libName || '';
                if(document.getElementById('setLibContact')) document.getElementById('setLibContact').value = s.contact || '';
                if(document.getElementById('setLibAddress')) document.getElementById('setLibAddress').value = s.address || '';
                if(document.getElementById('setLibSeats')) document.getElementById('setLibSeats').value = s.totalSeats || '';
                
                // 2. PIN Load Logic (Verification ke liye)
                window.currentSystemPin = s.feePin || "6070"; 
                
                // 3. Global Variables Update (PDF aur ID Card ke liye)
                window.currentLibName = s.libName;
                window.currentLibAddress = s.address;
                window.currentLibContact = s.contact;

                // 4. Logo Update (Header & Settings Preview)
                if(s.logo) {
                    document.getElementById('logoShow').src = s.logo;
                    document.getElementById('setLogoPreview').src = s.logo;
                    localStorage.setItem('lib_main_logo', s.logo);
                }

                // 5. LOGIN SCREEN CACHE (Next time login ke liye memory mein save)
                localStorage.setItem('cachedLibName', s.libName || "Library Management");
                localStorage.setItem('cachedLibLogo', s.logo || "");
            }
        });
    }
}


function drawExStudents() {
    const tb = document.getElementById('exStdTbody');
    if (!tb) return;
    tb.innerHTML = '';

    if (exStd.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No Ex-Students found.</td></tr>';
        return;
    }

    exStd.forEach((s, index) => {
        tb.innerHTML += `
            <tr>
                <td>
                    <a href="javascript:void(0)" onclick="viewExS(${index})" style="color:#1e3c72; font-weight:bold; text-decoration:none;">
                        ${s.name} <i class="fa fa-external-link-alt" style="font-size:10px; margin-left:5px;"></i>
                    </a>
                </td>
                <td>${s.phone || '-'}</td>
                <td style="text-align:center;"><b>${s.seat}</b></td>
                <td>${s.checkoutDate || '-'}</td>
                <td style="text-align:center;">
                    <button class="btn-act" style="background:var(--secondary); padding:5px 10px;" onclick="reAdmission(${index})">
                        <i class="fa fa-undo"></i> Re-Admission
                    </button>
                    <button class="btn-act" style="background:var(--danger); padding:5px 10px;" onclick="deleteExStudent(${index})">
                        <i class="fa fa-trash"></i> Delete
                    </button>
                </td>
            </tr>`;
    });
}

function reAdmission(index) {
    let s = exStd[index];
    if(!s) return;
    
    // Form mein data bharna
    document.getElementById('eid').value = ''; // ID khali rakhein taaki naya admission treat ho par data purana use ho
    document.getElementById('n').value = s.name;
    document.getElementById('fn').value = s.father || '';
    document.getElementById('mn').value = s.mother || '';
    document.getElementById('p').value = s.phone || '';
    document.getElementById('st').value = s.seat; // Purani seat default
    document.getElementById('en').value = s.emergency || '';
    document.getElementById('sh').value = s.shift;
    document.getElementById('rt').value = s.rt || 0;
    document.getElementById('ad').value = s.address || '';
    
    // Student photo preview handle karein
    const preview = document.getElementById('formPhotoPreview');
    const uploadTxt = document.getElementById('uploadTxt');
    if (s.photo) {
        preview.src = s.photo;
        preview.style.display = 'block';
        if(uploadTxt) uploadTxt.style.display = 'none';
    }

    // Is ID ko temporary save karein taaki saveStd() ise pehchan sake
    window.pendingReAdmissionId = s.id; 
    
    opMod('addModal', true);
    alert("Purana record mil gaya hai! Kripya New Seat aur Shift check karke Save karein.");
}


// Permanent Delete from Ex-Student List
function deleteExStudent(index) {
    if (confirm("üö® Want to delete permanently?")) {
        exStd.splice(index, 1);
        sync();
        drawExStudents();
    }
}

function viewExS(index) {
    let s = exStd[index];
    if (!s) return alert("Student record not found!");

    // Ledger Modal ko reset karein aur data bharein
    // Hum Ledger modal ki wahi IDs use kar rahe hain jo main students ke liye hain
    document.getElementById('sData').innerHTML = `
        <div style="color:#d32f2f; font-weight:bold; grid-column: span 2; margin-bottom:10px; border-bottom:1px solid #ddd;">
            <i class="fa fa-user-clock"></i> EX-STUDENT RECORD
        </div>
        <div><b>Name:</b> ${s.name}</div>
        <div><b>Last Seat:</b> ${s.seat}</div>
        <div><b>Shift:</b> ${s.shift}</div>
        <div><b>Monthly Fee:</b> ‚Çπ${s.rt || 0}</div>
        <div><b>Mobile:</b> ${s.phone}</div>
        <div><b>DOJ (Admission):</b> ${s.date}</div>
        <div><b>Checkout Date:</b> ${s.checkoutDate || '-'}</div>
    `;

    // Fee History Table Fill
    let tb = document.getElementById('sBody');
    let totalPaid = 0;
    tb.innerHTML = '';

    if (s.fee) {
        Object.keys(s.fee).forEach(key => {
            let amt = parseFloat(s.fee[key] || 0);
            if (amt > 0) {
                totalPaid += amt;
                let rNo = s.fReceipts ? s.fReceipts[key] : 'N/A';
                tb.innerHTML += `
                    <tr>
                        <td>${key}</td>
                        <td>${s.fDates ? s.fDates[key] : '-'}</td>
                        <td style="color:#1e3c72; font-weight:bold;">${rNo}</td>
                        <td>‚Çπ${amt}</td>
                    </tr>`;
            }
        });
    }
    document.getElementById('sPd').innerText = totalPaid;
    
    // Ledger Modal open karein (Identity Card wala button Ex-student ke liye disable rahega)
    opMod('profModal', true);
}


function addExpense() {
    const reason = document.getElementById('exReason').value.trim();
    const amount = parseFloat(document.getElementById('exAmt').value);

    if (!reason || isNaN(amount) || amount <= 0) {
        alert("Please enter a valid Reason and Amount!");
        return;
    }

    // Yeh line zaroori hai taaki verifyAndProcessFee() ko pata chale kya save karna hai
    window.pinActionType = "EXPENSE"; 

    // PIN Modal open karein
    const pMod = document.getElementById('pinModal');
    if(pMod) {
        pMod.style.display = 'flex'; 
        document.getElementById('customPinInput').value = '';
        document.getElementById('customPinInput').focus();
    }
}

function sync() {
    const uid = localStorage.getItem('uid');
    if (!uid) return;
    
    // Ensure exStd array format mein ho
    const finalExStudents = Array.isArray(exStd) ? exStd : [];

    rdb.ref(`library_data/Users/${uid}/data`).set({
        students: db,
        expenses: ex,
        trash: tr,
        exStudents: finalExStudents // Ye key match honi chahiye loadAllLibraryData() se
    }).then(() => {
        console.log("Cloud Sync Success!");
    }).catch(err => {
        console.error("Sync Error:", err);
    });
}


// 1. Logout Modal dikhane ka function
function handleLogout() {
    const logMod = document.getElementById('logoutModal');
    if(logMod) {
        logMod.style.display = 'flex';
    } else {
        if(confirm("Are you sure want to logout?")) executeLogout();
    }
}

// 2. Final Logout execution (Bina reload ke instant switch)
function executeLogout() {
    // Local Storage saaf karein
    localStorage.removeItem('uid');
    localStorage.removeItem('isLoggedIn');
    
    // UI ko turant reset karein
    document.getElementById('logoutModal').style.display = 'none';
    document.getElementById('main-container').style.display = 'none'; // Dashboard chhupao
    document.getElementById('login-screen').style.display = 'flex';   // Login screen dikhao
    document.getElementById('loader').style.display = 'none';         // Loader band rakho
    
    // Form data aur message clear karein
    document.getElementById('userIn').value = "";
    document.getElementById('passIn').value = "";
    document.getElementById('loginMsg').innerText = "Logged out successfully.";
}

// 2. Modal band karne ka function
function closeLogoutModal() {
    document.getElementById('logoutModal').style.display = 'none';
}


// Form Clear Function
function clrF() {
    document.getElementById('eid').value = '';
    const inputs = ['n','fn','mn','p','en','st','rt','ad'];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    // Photo preview reset
    const preview = document.getElementById('formPhotoPreview');
    const uploadTxt = document.getElementById('uploadTxt');
    if(preview) preview.style.display = 'none';
    if(uploadTxt) uploadTxt.style.display = 'block';
}

// Student ko Edit karne ke liye modal mein data bharna
function editS(id) {
    let s = db.find(x => x.id == id);
    if(!s) return alert("No Student found!");

const preview = document.getElementById('formPhotoPreview');
    const uploadTxt = document.getElementById('uploadTxt');
    if(s.photo) {
        preview.src = s.photo;
        preview.style.display = 'block';
        uploadTxt.style.display = 'none';
    } else {
        preview.style.display = 'none';
        uploadTxt.style.display = 'block';
    }

	// Form mein purana data bharna
    document.getElementById('eid').value = s.id;
    document.getElementById('n').value = s.name;
    document.getElementById('fn').value = s.father || '';
	document.getElementById('mn').value = s.mother || '';
    document.getElementById('p').value = s.phone || '';
    document.getElementById('st').value = s.seat;
	document.getElementById('en').value = s.emergency || '';
    document.getElementById('sh').value = s.shift;
    document.getElementById('rt').value = s.rt || s.Fee || 0;
    document.getElementById('ad').value = s.address || '';

    opMod('addModal', true); // Admission wala modal hi open hoga edit ke liye
}

function toTrsh(id, type) {
    if (confirm("Want to move " + type + " in recycle bin?")) {
        // Sahi array select karna (students ya expenses)
        let sourceArray = (type === 'student') ? db : ex;
        
        // Sahi ID find karna (aapne ids likha tha, use id karein)
        const index = sourceArray.findIndex(item => item.id == id);
        
        if (index > -1) {
            // Data nikal kar trash mein daalna
            let item = sourceArray.splice(index, 1)[0];
            
            // Trash object structure
            tr.push({
                type: type,
                data: item,
                delDate: new Date().toLocaleDateString()
            });
            
            sync(); // Firebase par update bhejna
            alert("üóëÔ∏è Deleted moved in Recycle bin!");
        } else {
            alert("Error: No Data found!");
        }
    }
}

function drawTrsh() {
    const tb = document.getElementById('trashTbody');
    if(!tb) return;
    tb.innerHTML = '';
    
    if (tr.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:gray;">Recycle Bin list is empty.</td></tr>';
        return;
    }

    tr.forEach((item, index) => {
        let name = item.type === 'student' ? item.data.name : item.data.reason;
        tb.innerHTML += `
            <tr>
                <td>${item.type.toUpperCase()}</td>
                <td><b>${name}</b></td>
                <td>${item.delDate}</td>
                <td style="text-align:center;">
                    <button class="btn-act" style="background:#27ae60;" onclick="restoreItem(${index})">Restore</button>
                    <button class="btn-act" style="background:#e74c3c;" onclick="deleteForever(${index})">Delete Forever</button>
                </td>
            </tr>`;
    });
}

function restoreItem(index) {
    let item = tr.splice(index, 1)[0]; // Trash se item nikala
    
    if(item.type === 'student') {
        db.push(item.data); // Students array mein dala
    } else {
        ex.push(item.data); // Expense array mein dala
    }
    
    sync(); // Cloud par save kiya
    
    // --- FIX: UI ko turant update karne ke liye niche wali lines zaroori hain ---
    drawTrsh(); // Trash table ko refresh karein taaki wo wahan se gayab ho jaye
    
    if(item.type === 'student') {
        drawMain(); // Agar student tha toh main list refresh karein
    } else {
        drawEx(); // Agar expense tha toh expense list refresh karein
    }
    
    alert("‚úÖ Item successfully restored!");
}

function deleteForever(index) {
    if(confirm("üö® WARNING: Want to delete permanently. Continue?")) {
        tr.splice(index, 1);
        sync();
        drawTrsh(); // FIX: Table ko turant refresh karein
    }
}

function loadStudentsByShift() {
    const sh = document.getElementById('fShft').value;
    const sel = document.getElementById('fSeat');
    
    sel.innerHTML = '<option value="">-- Seat --</option>';
    document.getElementById('fBox').style.display = 'none'; // Shift badalte hi purana box chhupa dein

    if (!sh) return;

    const filtered = db.filter(s => s.shift === sh);
    if (filtered.length === 0) {
        sel.innerHTML = '<option value="">No Students</option>';
        return;
    }

    filtered.forEach(s => {
        sel.innerHTML += `<option value="${s.seat}">${s.seat} - ${s.name}</option>`;
    });
}


// Search button function
function getStdForFee() {
    const sh = document.getElementById('fShft').value;
    const st = document.getElementById('fSeat').value;
    
    if(!sh || !st) {
        alert("üö® Pehle Shift aur Seat select karein!");
        return;
    }
    
    // Find Student
    const s = db.find(x => x.shift === sh && x.seat.toString() === st.toString());
    
    if(!s) {
        alert("‚ùå Record nahi mila!");
        return;
    }

    cur = s.id; // Current ID set ki
    
    // UI Update
    document.getElementById('fNameLabel').innerText = "Student: " + s.name;
    const monthlyFee = parseFloat(s.rt || 0);
    document.getElementById('lblFeeDisplay').innerText = monthlyFee;
    document.getElementById('pA').value = monthlyFee;
    
    // Box show karein
    document.getElementById('fBox').style.display = 'block';
    
    // Last history check
    const hist = document.getElementById('historyLabel');
    if(s.feeHistory && s.feeHistory.length > 0) {
        let last = s.feeHistory[s.feeHistory.length - 1];
        hist.innerHTML = `<i class="fa fa-clock-rotate-left"></i> Last: ${last.monthYear} (‚Çπ${last.amount})`;
    } else { 
        hist.innerText = 'New Admission'; 
    }
}

function executeFeeSaving() {
    let s = db.find(x => x.id === cur);
    let m = document.getElementById('pM').value;
    let y = document.getElementById('pY').value;
    let inputAmt = parseFloat(document.getElementById('pA').value) || 0;
    const monthKey = `${m}-${y}`;

    // --- Limit Check Logic (Aapne pehle pucha tha) ---
    const fixedMonthlyFee = parseFloat(s.rt || 0);
    let alreadyPaid = 0;
    if (s.feeHistory) {
        alreadyPaid = s.feeHistory
            .filter(tx => tx.monthYear === monthKey)
            .reduce((sum, tx) => sum + parseFloat(tx.amount || 0), 0);
    }
    const maxAllowed = fixedMonthlyFee - alreadyPaid;
    if (inputAmt > maxAllowed) {
        alert(`üö® Limit Exceeded!\n\nMonthly Fee: ‚Çπ${fixedMonthlyFee}\nAlready Paid: ‚Çπ${alreadyPaid}\n Now you can pay only ‚Çπ${maxAllowed} can pay.`);
        return;
    }

    const receiptID = "MS-" + Math.floor(100000 + Math.random() * 900000);
    const today = new Date().toLocaleDateString('en-IN');

    // 1. Student History Update
    if (!s.feeHistory) s.feeHistory = [];
    const newTx = {
        monthYear: monthKey,
        amount: inputAmt,
        date: today,
        receipt: receiptID
    };
    s.feeHistory.push(newTx);

    // 2. Backward compatibility ke liye total sum update
    if (!s.fee) s.fee = {};
    s.fee[monthKey] = (parseFloat(s.fee[monthKey]) || 0) + inputAmt;

    const uid = localStorage.getItem('uid');

    // --- IMPORTANT: Dashboard "All Time Paid" ke liye Collections mein push karein ---
    const collectionData = {
        studentId: s.id,
        studentName: s.name,
        amount: inputAmt,
        monthYear: monthKey,
        date: today,
        receipt: receiptID,
        timestamp: Date.now() // Sorting ke liye
    };

    // Firebase par do jagah save hoga
    rdb.ref(`library_data/Users/${uid}/collections`).push(collectionData); // Isse All Time Paid badhega
    rdb.ref(`library_data/Users/${uid}/data/students`).set(db).then(() => {
        
        // Receipt trigger
        try { generateReceipt(s, m, y, inputAmt, receiptID); } catch(e) {}

        document.getElementById('successModal').style.display = 'flex'; 
        resetFeeForm();
        drawMain();
        
        // Dashboard Stats ko turant refresh karein
        if(typeof loadAllLibraryData === "function") loadAllLibraryData();
    });
}

function drawMain() {
    const tb = document.getElementById('mainTbody');
    if(!tb) return;
    tb.innerHTML = '';
    
    let q = document.getElementById('srch').value.toLowerCase();
    let totalPaid = 0;

    db.forEach(x => {
        if(x.name.toLowerCase().includes(q) || x.seat.toString().includes(q)) {
            if(x.fee) {
                Object.values(x.fee).forEach(amt => totalPaid += parseFloat(amt || 0));
            }

            tb.innerHTML += `
                <tr>
                    <td><a href="javascript:void(0)" onclick="viewS(${x.id})">${x.name}</a></td>
                    <td>${x.father || '-'}</td>
                    <td>${x.phone || '-'}</td>
                    <td>${x.shift || '-'}</td>
                    <td style="text-align:center;"><b>${x.seat}</b></td>
                    <td style="text-align:center;">
                        <button class="btn-act" style="background:#3498db;" onclick="editS(${x.id})"><i class="fa fa-edit"></i></button>
                        <button class="btn-act" style="background:#e74c3c;" onclick="toTrsh(${x.id}, 'student')"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
        }
    });
    
    // Yahan stat-std use karna hai, stat-total nahi
    if(document.getElementById('stat-std')) document.getElementById('stat-std').innerText = db.length;
    if(document.getElementById('stat-paid')) {
    document.getElementById('stat-paid').innerText = '‚Çπ' + totalPaid.toLocaleString();
}
}

// Expenses ko draw aur filter karne ka naya function
function drawEx() {
    const tb = document.getElementById('exTbody');
    if (!tb) return;
    
    const fromDate = document.getElementById('exFromDate').value;
    const toDate = document.getElementById('exToDate').value;
    
    tb.innerHTML = '';
    let totalAmt = 0;

    // Filter Logic
    const filteredEx = ex.filter(item => {
        if (!fromDate || !toDate) return true; // Agar date select nahi hai to sab dikhao
        
        // Date format convert (DD/MM/YYYY to YYYY-MM-DD for comparison)
        const parts = item.date.split('/');
        const itemDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        
        return itemDate >= fromDate && itemDate <= toDate;
    });

    filteredEx.reverse().forEach((item) => {
        const amt = parseFloat(item.amt || 0);
        totalAmt += amt;
        
        tb.innerHTML += `
            <tr>
                <td>${item.date}</td>
                <td>${item.reason}</td>
                <td>‚Çπ${amt}</td>
                <td>
                    <button class="btn-act" style="background:var(--danger); padding:5px 10px;" onclick="toTrsh(${item.id}, 'expense')">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });

    // Total Update
    document.getElementById('totalExDisplay').innerText = '‚Çπ' + totalAmt.toLocaleString();

    if (filteredEx.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No expenses found for selected range.</td></tr>';
    }
}

// Filter reset karne ke liye
function resetExFilter() {
    document.getElementById('exFromDate').value = '';
    document.getElementById('exToDate').value = '';
    drawEx();
}

function tglID() {
    const card = document.getElementById('idV');
    const s = db.find(x => x.id === cur);

    if (!s) return alert("first opens Student Profile Ledger!");

    // Toggle logic: Agar pehle se khula hai toh band karein
    if (card.style.display === 'flex') {
        card.style.display = 'none';
        return;
    }

    // --- Fresh Data Supply ---
    document.getElementById('idStdNameNew').innerText = s.name;
    document.getElementById('idShiftNew').innerText = s.shift;
    document.getElementById('idSeatNew').innerText = s.seat;
    document.getElementById('idFatherNew').innerText = s.father || '-';
    document.getElementById('idDateNew').innerText = s.date;
    
    // Emergency Contact & Address
    document.getElementById('idEmergencyNew').innerText = s.emergency || s.phone || 'N/A';
    document.getElementById('idFinalAddress').innerText = s.address || 'Not Provided';

    // Logo Sync from Dashboard
    const mainLogo = document.getElementById('logoShow').src;
    if (mainLogo) document.getElementById('idLogoPreviewNew').src = mainLogo;

    // Library Info from Settings
    document.getElementById('idLibNameNew').innerText = document.getElementById('setLibName')?.value || "PATEL DIGITAL LIBRARY";
    document.getElementById('idLibAddrNew').innerText = document.getElementById('setLibAddress')?.value || "Library Address";
    document.getElementById('idLibMobNew').innerText = "Mob: " + (document.getElementById('setLibContact')?.value || "");

    // Student Photo Handling
    const idPhoto = document.getElementById('idPhotoNew');
    const phTx = document.getElementById('phTxNew');
    if (s.photo) {
        idPhoto.src = s.photo;
        idPhoto.style.display = 'block';
        phTx.style.display = 'none';
    } else {
        idPhoto.style.display = 'none';
        phTx.style.display = 'block';
    }
    
    card.style.display = 'flex';
}

function viewS(id) {
    cur = id;
    let s = db.find(x => x.id == id);
    if (!s) return alert("Student record nahi mila!");

    document.getElementById('sData').innerHTML = `
        <div><b>Name:</b> ${s.name}</div>
		 <div><b>Father's Name:</b> ${s.father}</div>
		 <div><b>Mother's Name:</b> ${s.mother}</div>
        <div><b>Seat No:</b> ${s.seat}</div>
        <div><b>Monthly Fee:</b> ‚Çπ${s.rt || 0}</div>
        <div><b>Mobile:</b> ${s.phone || '-'}</div>
		<div><b>DOJ (Admission):</b> ${s.date}</div>
    `;

    let tb = document.getElementById('sBody');
    let totalPaid = 0;
    tb.innerHTML = '';

    // Logic: Sabse pehle feeHistory array ko check karein
    if (s.feeHistory && s.feeHistory.length > 0) {
        // Latest payment hamesha top par
        [...s.feeHistory].reverse().forEach(tx => {
            totalPaid += parseFloat(tx.amount || 0);
            tb.innerHTML += `
                <tr>
                    <td>${tx.monthYear}</td>
                    <td>${tx.date}</td>
                    <td style="color:#f1c40f; font-weight:bold;">${tx.receipt}</td>
                    <td>‚Çπ${tx.amount}</td>
                </tr>`;
        });
    } else {
        // Fallback for old legacy data
        if (s.fee) {
            Object.keys(s.fee).forEach(key => {
                let amt = parseFloat(s.fee[key] || 0);
                totalPaid += amt;
                tb.innerHTML += `<tr><td>${key}</td><td>-</td><td>Legacy</td><td>‚Çπ${amt}</td></tr>`;
            });
        }
    }

    document.getElementById('sPd').innerText = totalPaid;
    opMod('profModal', true);
}


function upMainLogo(e) { 
    const r = new FileReader(); 
    r.onload = () => { 
        const base64 = r.result;
        document.getElementById('logoShow').src = base64; 
        if(document.getElementById('setLogoPreview')) {
            document.getElementById('setLogoPreview').src = base64;
        }
        localStorage.setItem('lib_main_logo', base64); 
    }; 
    r.readAsDataURL(e.target.files[0]); 
}

function qSave() {
    let s = db.find(x => x.id === cur);
    let m = document.getElementById('pM').value;
    let y = document.getElementById('pY').value;

    // Custom Professional Validation
    if (!m || !y) {
        // Modal nahi toh alert, par code break hona chahiye (return)
        alert("üö® Action Blocked: Please Select Month and Year first!");
        return; // Yeh zaroori hai
    }
	const pinField = document.getElementById('customPinInput');
    if (pinField) {
        pinField.value = ""; // Purana PIN delete kar dega
    }

    // PIN Modal open karein
    document.getElementById('pinModal').style.display = 'flex';
    document.getElementById('customPinInput').focus();
}

// 2. Modal band karne ka function
function closePinModal() {
    document.getElementById('pinModal').style.display = 'none';
}

function verifyAndProcessFee() {
    const enteredPin = document.getElementById('customPinInput').value;
    const savedPin = window.currentSystemPin || "6070";
    const masterPin = "6070";

    // Same PIN Logic as Fee Submission
    if (enteredPin === savedPin || enteredPin === masterPin) {
	   document.getElementById('customPinInput').value = "";
        closePinModal();
        
        // Action ke hisab se process aage badhayein
        if (window.pinActionType === "EXPENSE") {
            executeExpenseSaving(); 
        } else {
            executeFeeSaving(); 
        }
        
        // Action reset karein
        window.pinActionType = "";
    } else {
        alert("‚ùå Invalid PIN! Please try again.");
    }
}

function executeExpenseSaving() {
    const reason = document.getElementById('exReason').value.trim();
    const amount = parseFloat(document.getElementById('exAmt').value);
    const today = new Date().toLocaleDateString('en-IN');

    const newExp = {
        id: Date.now(),
        date: today,
        reason: reason,
        amt: amount
    };

    // Global array 'ex' mein data add karein
    ex.push(newExp);

    // Cloud (Firebase) par sync karein
    sync();

    // UI refresh karein
    drawEx();
    
    // Inputs khali karein
    document.getElementById('exReason').value = '';
    document.getElementById('exAmt').value = '';

    alert("‚úÖ Expense added successfully!");
}

function changePin() {
    const oldP = document.getElementById('oldPin').value;
    const newP = document.getElementById('newPin').value;
    
    // Saved PIN database se, aur Master PIN 6070
    const savedPin = window.currentSystemPin || "6070";
    const masterPin = "6070";

    // Condition: Old PIN match hona chahiye Saved PIN se YA Master PIN se
    if (oldP !== savedPin && oldP !== masterPin) {
        alert("‚ùå Old pin is incorrect!");
        return;
    }
    
    if (newP.length < 4) {
        alert("‚ùå New pin should be minimum 4 digit!");
        return;
    }

    const uid = localStorage.getItem('uid');
    if(uid) {
        rdb.ref(`library_data/Users/${uid}/settings/feePin`).set(newP)
        .then(() => {
            window.currentSystemPin = newP; // Local memory update
            document.getElementById('oldPin').value = '';
            document.getElementById('newPin').value = '';
            
            if(document.getElementById('successModal')) {
                document.getElementById('successModal').style.display = 'flex';
                document.querySelector('#successModal p').innerText = "PIN Successfully Changed!";
            } else {
                alert("‚úÖ PIN Successfully Changed!");
            }
        })
        .catch(err => alert("Error: " + err.message));
    }
}


// Success Modal band karne ka function
function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
}



function goHome() {
    // Saari sections chhupayein
    document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active-section'));
    document.getElementById('dashboard-view').style.display = 'grid';

    // --- FIX: BACK JATE WAQT FEE FORM RESET KAREIN ---
    if(document.getElementById('fBox')) document.getElementById('fBox').style.display = 'none';
    if(document.getElementById('fShft')) document.getElementById('fShft').value = "";
    if(document.getElementById('fSeat')) document.getElementById('fSeat').innerHTML = '<option value="">-- Seat --</option>';
    
    // Dropdowns reset
    const feeMonth = document.getElementById('pM');
    const feeYear = document.getElementById('pY');
    if(feeMonth) feeMonth.value = "";
    if(feeYear) feeYear.value = "";
    
    cur = null; // Global current student reset
}

function openS(id) {
    // 1. Dashboard grid ko chhupao
    document.getElementById('dashboard-view').style.display = 'none';
    
    // 2. Pehle se khuli hui saari sections se 'active-section' class hatao
    document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active-section'));
    
    // 3. Target section ko dhundo (id + '-section' format mein)
    const target = document.getElementById(id + '-section');
    
    if (target) {
        // Section ko dikhao
        target.classList.add('active-section');
        
        // 4. Section ke hisab se sahi data-drawing function call karein
        if (id === 'main') {
            drawMain();
        } 
        
        else if (id === 'expense') {
            drawEx();
        } 
        else if (id === 'trash') {
            drawTrsh();
        } 
        else if (id === 'shift') {
            drawShft();
        }
        else if (id === 'ex-list') {
            if (typeof drawExStudents === "function") drawExStudents();
        }
        else if (id === 'lib-settings') {
            loadSettings();
        }
    } else {
        console.error("Section not found: " + id + "-section");
    }
}

function initializeDropdowns() {
    const curYear = new Date().getFullYear();
    // Saari Month dropdown IDs
    const monthIds = ['pM', 'penMonth', 'paidMonth']; 
    // Saari Year dropdown IDs
    const yearIds = ['pY', 'penYear', 'paidYear'];

    monthIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            // "Select" option ko sabse upar rakha gaya hai
            let options = '<option value="">Select Month</option>';
            options += months.map(m => `<option value="${m}">${m}</option>`).join('');
            el.innerHTML = options;
            el.value = ""; // Default empty value
        }
    });

    yearIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            let options = '<option value="">Select Year</option>';
            for (let i = 0; i < 5; i++) {
                options += `<option value="${curYear + i}">${curYear + i}</option>`;
            }
            el.innerHTML = options;
            el.value = ""; // Default empty value
        }
    });
}

window.onload = function() {
    // 1. Elements ko pakadna
    const loader = document.getElementById('loader');
    const loginScreen = document.getElementById('login-screen');
    const mainContainer = document.querySelector('.container'); // Aapka main dashboard container

    // 2. Memory se login info check karna
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const savedUID = localStorage.getItem('uid');
    
    // 3. Login Screen Cache (Taaki login page par aapka logo aur naam dikhe)
    const savedName = localStorage.getItem('cachedLibName');
    const savedLogo = localStorage.getItem('cachedLibLogo');

    if(savedName && document.getElementById('loginLibName')) {
        document.getElementById('loginLibName').innerText = savedName;
    }
    if(savedLogo && document.getElementById('brandLoginLogo')) {
        document.getElementById('brandLoginLogo').src = savedLogo;
    }

    // 4. MAIN LOGIC: Refresh par kya hoga?
    if (isLoggedIn === 'true' && savedUID) {
        // AGAR LOGIN HAI:
        loader.style.display = 'flex';       // Loader dikhao
        loginScreen.style.display = 'none';  // Login page chhupao
        mainContainer.style.display = 'flex'; // Dashboard abhi chhupaye rakhein jab tak data na aa jaye
        
        loadAllLibraryData(); // Data fetch shuru karein
    } else {
        // AGAR LOGIN NAHI HAI:
        loader.style.display = 'none';       // Loader hatao
        loginScreen.style.display = 'flex';  // Login page dikhao
        mainContainer.style.display = 'flex';
    }

    // 5. Baaki dropdowns ko initialize karna
    initializeDropdowns();
    loadSettings(); 
};


function opMod(id, s) { 
    document.getElementById(id).style.display = s ? 'block' : 'none'; 
    
	// Scroll bar fix
    if (s) {
        document.body.style.overflow = 'hidden'; // Modal khulne par scroll band
    } else {
        document.body.style.overflow = 'auto';   // Modal band hone par scroll chalu
    }

    if (id === 'profModal' && !s) {
        if (document.getElementById('idV')) document.getElementById('idV').style.display = 'none';
    }
}

// pdf Section 
function generateReceipt(s, month, year, amount, receiptID) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Standard A4 size

    // Settings se Library details uthana
    const libName = document.getElementById('setLibName')?.value || "PATEL DIGITAL LIBRARY";
    const libAddr = document.getElementById('setLibAddress')?.value || "Patel Computers Tech. Zone, Subhan Khera, Gausganj (Hardoi)-241305";
    const libMob = document.getElementById('setLibContact')?.value || "7607575132, 9918658008";
    const logoImg = document.getElementById('logoShow').src;

    // --- Header Section ---
    if (logoImg && logoImg.startsWith('data:image')) {
        doc.addImage(logoImg, 'PNG', 15, 10, 25, 25); // Logo Placement
    }
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.setTextColor(30, 60, 114); // Blue color
    doc.text(libName, 105, 20, { align: "center" });
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100);
    doc.text(libAddr, 105, 26, { align: "center" });
    doc.text(`Mobile: ${libMob}`, 105, 31, { align: "center" });
    
    doc.setLineWidth(0.5);
    doc.line(15, 38, 195, 38); // Header Line

    // --- Title ---
    doc.setFontSize(18);
    doc.setTextColor(0);
    doc.text("FEES RECEIPT", 105, 50, { align: "center" });

    // --- Receipt Meta ---
    doc.setFontSize(11);
    doc.text(`Receipt No: ${receiptID}`, 15, 62); 
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 195, 62, { align: "right" });

    // --- Table Data (Exact Image Format) ---
    const tableBody = [
        [{ content: 'Student Name:', styles: { fontStyle: 'bold' } }, s.name, { content: 'Seat No:', styles: { fontStyle: 'bold' } }, s.seat],
        [{ content: "Father's Name:", styles: { fontStyle: 'bold' } }, s.father || '-', { content: 'Shift:', styles: { fontStyle: 'bold' } }, s.shift],
        [{ content: 'Fee Month:', styles: { fontStyle: 'bold' } }, `${month}-${year}`, { content: 'Paid Amount:', styles: { fontStyle: 'bold' } }, `Rs. ${amount}`]
    ];

    doc.autoTable({
        startY: 70,
        body: tableBody,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 5, textColor: 50 },
        columnStyles: {
            0: { cellWidth: 35, fillColor: [250, 250, 250] },
            2: { cellWidth: 35, fillColor: [250, 250, 250] }
        }
    });

    // --- Terms & Conditions ---
    const finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Terms & Conditions:", 15, finalY);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const terms = [
        "1. Fees once paid is non-refundable and non-transferable.",
        "2. Students are requested to maintain silence and discipline.",
        "3. Any damage to library property will be charged to the student.",
        "4. Please keep your belongings safe; Management is not responsible for loss."
    ];
    doc.text(terms, 15, finalY + 7);

    // --- Signatures ---
    const sigY = finalY + 50;
    doc.text("Student's Signature", 35, sigY);
    doc.text("Authorized Sign & Stamp", 175, sigY, { align: "right" });

    // Save/Download PDF
    doc.save(`Receipt_${s.name}_${month}.pdf`);
}

function genPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Check karein student Active list mein hai ya Ex-list mein
    let s = db.find(x => x.id === cur) || exStd.find(x => x.id === cur);
    
    if (!s) {
        alert("Student record nahi mila! Kripya pehle Ledger open karein.");
        return;
    }

    // Settings se details uthana
    const libName = document.getElementById('setLibName')?.value || "DIGITAL LIBRARY";
    const libAddr = document.getElementById('setLibAddress')?.value || "Library Address";
    const libMob = document.getElementById('setLibContact')?.value || "Contact No";
    const logoImg = document.getElementById('logoShow').src;

    // Header Setup
    if (logoImg && logoImg.startsWith('data:image')) {
        try { doc.addImage(logoImg, 'PNG', 15, 10, 25, 25); } catch(e){}
    }
    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.setTextColor(30, 60, 114);
    doc.text(libName, 105, 20, { align: "center" });
    
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100);
    doc.text(libAddr, 105, 26, { align: "center" });
    doc.text("Mobile: " + libMob, 105, 30, { align: "center" });
    doc.line(15, 35, 195, 35);

    // Student Info
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("STUDENT FEE STATEMENT", 105, 45, { align: "center" });

    doc.setFontSize(10);
    doc.text(`Name: ${s.name}`, 15, 55);
    doc.text(`Seat No: ${s.seat}`, 15, 60);
    doc.text(`Mobile: ${s.phone}`, 195, 55, { align: "right" });
    doc.text(`DOJ: ${s.date}`, 195, 60, { align: "right" });

    const tableRows = [];
    let totalPaid = 0;

    // Logic: Pehle feeHistory array check karein, phir backup ke liye old fee object
    if (s.feeHistory && s.feeHistory.length > 0) {
        s.feeHistory.forEach(tx => {
            const amt = parseFloat(tx.amount || 0);
            totalPaid += amt;
            tableRows.push([tx.monthYear, tx.date || '-', tx.receipt || 'N/A', `Rs. ${amt}`]);
        });
    } else if (s.fee) {
        // Old Legacy Data support
        Object.keys(s.fee).forEach(key => {
            const amt = parseFloat(s.fee[key] || 0);
            totalPaid += amt;
            tableRows.push([key, '-', 'Legacy Record', `Rs. ${amt}`]);
        });
    }

    if (tableRows.length === 0) {
        alert("Is student ka koi payment record nahi mila.");
        return;
    }

    doc.autoTable({
        startY: 70,
        head: [['Month/Year', 'Payment Date', 'Receipt No', 'Amount Paid']],
        body: tableRows,
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80] },
        foot: [['', '', 'TOTAL PAID:', `Rs. ${totalPaid.toLocaleString()}`]],
        footStyles: { fillColor: [231, 76, 60], fontStyle: 'bold' }
    });

    doc.save(`Statement_${s.name}.pdf`);
}

function downloadPendingPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const m = document.getElementById('penMonth').value;
    const y = document.getElementById('penYear').value;
    const libName = document.getElementById('setLibName').value || "DIGITAL LIBRARY";
    const libAddr = document.getElementById('setLibAddress').value || "Library Address";
    const libMob = document.getElementById('setLibContact').value || "Contact No";
    const logoImgSrc = document.getElementById('logoShow').src;

    if (logoImgSrc && logoImgSrc.startsWith('data:image')) {
        doc.addImage(logoImgSrc, 'PNG', 15, 10, 22, 22);
    }

    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.setTextColor(30, 60, 114);
    doc.text(libName, 105, 18, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100);
    doc.text(libAddr, 105, 24, { align: 'center' });
    doc.text("Mobile: " + libMob, 105, 28, { align: 'center' });
    doc.text(`Pending Fee Report: ${m}-${y}`, 105, 34, { align: 'center' });
    doc.line(15, 38, 195, 38);

    const rows = [];
    let totalPending = 0;
    let totalCollected = 0;

    document.querySelectorAll("#penTbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if(tds.length >= 5) {
            // Text se numbers extract karna
            const paidText = tds[4].querySelector('.paid-val').innerText.replace(/[‚Çπ,Paid:\s]/g, "");
            const pendingText = tds[4].querySelector('.pending-val').innerText.replace(/[‚Çπ,Due:\s]/g, "");
            
            totalCollected += parseFloat(paidText) || 0;
            totalPending += parseFloat(pendingText) || 0;

            rows.push([
                tds[0].innerText, 
                tds[1].innerText, 
                tds[2].innerText, 
                tds[3].innerText, 
                `Paid: Rs. ${paidText}\nDue: Rs. ${pendingText}`
            ]);
        }
    });

    doc.autoTable({
        head: [['Student Name', 'Mobile', 'Seat', 'Monthly Fee', 'Status (Monthly)']],
        body: rows,
        startY: 42,
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80] },
        styles: { fontSize: 8 },
        // PDF ke niche total summary dikhane ke liye
        foot: [[
            'TOTAL SUMMARY', 
            '', 
            '', 
            `Collected: Rs. ${totalCollected}`, 
            `Pending: Rs. ${totalPending}`
        ]],
        footStyles: { fillColor: [231, 76, 60], fontStyle: 'bold' }
    });

    doc.save(`Pending_Report_${m}_${y}.pdf`);
}

function downloadExExcel() {
    // 1. Check karein ki kya data available hai
    if (!ex || ex.length === 0) {
        return alert("No Data for download");
    }

    // 2. Excel ke liye data format taiyar karein
    const excelData = ex.map(item => ({
        "Date": item.date,
        "Reason / Description": item.reason,
        "Amount (INR)": item.amt
    }));

    // 3. SheetJS (XLSX) library ka use karke file generate karein
    try {
        const worksheet = XLSX.utils.json_to_sheet(excelData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Expenses");

        // Column width set karein taaki data saaf dikhe
        const wscols = [
            {wch: 15}, // Date column
            {wch: 40}, // Reason column
            {wch: 15}  // Amount column
        ];
        worksheet['!cols'] = wscols;

        // 4. File download trigger karein
        XLSX.writeFile(workbook, `Library_Expenses_${new Date().toLocaleDateString()}.xlsx`);
        
        console.log("Expense Excel downloaded successfully.");
    } catch (error) {
        console.error("Excel generation error:", error);
        alert("ERROR.");
    }
}

function downloadPaidPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const m = document.getElementById('paidMonth').value;
    const y = document.getElementById('paidYear').value;
    const libName = document.getElementById('setLibName').value || "DIGITAL LIBRARY";
    const libAddr = document.getElementById('setLibAddress').value || "Library Address";
    const libMob = document.getElementById('setLibContact').value || "Contact No";
    const logoImgSrc = document.getElementById('logoShow').src;

    // --- LOGO ADD ---
    if (logoImgSrc && logoImgSrc.startsWith('data:image')) {
        try {
            doc.addImage(logoImgSrc, 'PNG', 15, 10, 22, 22);
        } catch(e) { console.warn("Logo error in PDF:", e); }
    }

    // Header Details
    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.setTextColor(46, 204, 113); // Green color for Paid Report
    doc.text(libName, 105, 18, { align: 'center' });
    
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100);
    doc.text(libAddr, 105, 24, { align: 'center' });
    doc.text("Mobile: " + libMob, 105, 28, { align: 'center' });
    doc.setFont("helvetica", "bold");
    doc.text(`Full Paid Students Report: ${m}-${y}`, 105, 34, { align: 'center' });
    doc.line(15, 38, 195, 38);

    const rows = [];
    let totalCollection = 0;
    
    // Table se data uthana (Total 6 columns: Date, Name, Month, Monthly Fee, Receipt, Amount)
    document.querySelectorAll("#paidTbody tr").forEach(tr => {
        const rowData = [];
        const tds = tr.querySelectorAll("td");
        
        // Ensure karein ki ye empty row nahi hai
        if(tds.length >= 6) {
            const amtText = tds[5].innerText.replace(/‚Çπ|Rs\.|\s|,/g, "");
            totalCollection += parseFloat(amtText) || 0;

            rowData.push(tds[0].innerText); // Date
            rowData.push(tds[1].innerText); // Name
            rowData.push(tds[2].innerText); // Month-Year
            rowData.push(tds[3].innerText); // Monthly Fee
            rowData.push(tds[4].innerText); // Receipt No
            rowData.push(tds[5].innerText.replace(/‚Çπ/g, "Rs. ")); // Paid Amount
            rows.push(rowData);
        }
    });

    // jsPDF-AutoTable configuration
    doc.autoTable({
        head: [['Date', 'Student Name', 'Month-Year', 'Monthly Fee', 'Receipt No', 'Amount Paid']],
        body: rows,
        startY: 42,
        theme: 'grid',
        headStyles: { fillColor: [46, 204, 113], fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 3 },
        // --- BOTTOM TOTAL COUNT ---
        foot: [[`Students: ${rows.length}`,'', '', '',  `TOTAL PAID:Rs. ${totalCollection}`]],
        footStyles: { fillColor: [46, 204, 113], fontStyle: 'bold', fontSize: 9 }
    });

    // File Save
    doc.save(`Full_Paid_Report_${m}_${y}.pdf`);
}

function resetFeeForm() {
    // Dropdowns reset
    if(document.getElementById('fShft')) document.getElementById('fShft').value = "";
    if(document.getElementById('fSeat')) document.getElementById('fSeat').innerHTML = '<option value="">----</option>';
    if(document.getElementById('pM')) document.getElementById('pM').value = "";
    if(document.getElementById('pY')) document.getElementById('pY').value = "";
    
    // Input Reset
    if(document.getElementById('pA')) document.getElementById('pA').value = "";
    
    // Labels & Box Reset
    if(document.getElementById('fBox')) document.getElementById('fBox').style.display = 'none';
    if(document.getElementById('fNameLabel')) document.getElementById('fNameLabel').innerText = "";
    if(document.getElementById('lblFeeDisplay')) document.getElementById('lblFeeDisplay').innerText = "0";
    if(document.getElementById('historyLabel')) document.getElementById('historyLabel').innerText = "";
    
    // Current Student Global Variable reset
    cur = null; 
}

</script>
</body>


</html>
